<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BINBEMQMES03">
    <sql id="insertMemberInfoKeySql">
        <isNotEmpty property="genderCode">
            Gender,
        </isNotEmpty>
        <isNotEmpty property="activeChannel">
            ActiveChannel,
        </isNotEmpty>
        <isNotEmpty property="tmallAccount">
            TmallAccount,
        </isNotEmpty>
        <isNotEmpty property="firstUpTime">
            FirstUpTime,
        </isNotEmpty>
    </sql>
    
    <sql id="insertMemberInfoValueSql">
        <isNotEmpty property="genderCode">
            #genderCode#,
        </isNotEmpty>
        <isNotEmpty property="activeChannel">
            #activeChannel#,
        </isNotEmpty>
        <isNotEmpty property="tmallAccount">
            #tmallAccount#,
        </isNotEmpty>
         <isNotEmpty property="firstUpTime">
            #firstUpTime#,
        </isNotEmpty>
    </sql>

	<!-- 插入会员信息表 -->
	<insert id="addMemberInfo" parameterClass="java.util.HashMap">
	    <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_MemberInfoID" >      
	       <![CDATA[
			INSERT INTO Members.BIN_MemberInfo
			(
				BIN_OrganizationInfoID,
				BIN_BrandInfoID,
				Name,
				Telephone,
				MobilePhone,
				Email,
				BIN_RegionID,
				BirthYear,
				BirthDay,
				JoinDate,
				InitJoinDate,
				BIN_EmployeeID,
				BaCodeBelong,
				BIN_OrganizationID,
				CounterCodeBelong,
				MemInfoRegFlg,
				MemInfoRegDate,
				ChannelCode,
				MemberLevel,
				LevelStatus,
				LevelStartDate,
				LevelEndDate,
				JoinTime,
				ReferrerID,
				GrantMemberLevel,
				LevelAdjustDay,
				BirthYearGetType,
				TestType,
				Version,
				Memo1,
				Memo2,
				Active,
				ActiveDate,
				MemberPassword,
				OrigJoinDate,
				OrigEmployeeID,
				OrigBaCodeBelong,
				OrigOrganizationID,
				OrigCounterCodeBelong,
				TmallMixMobile,				
				BindFlag,				
				IsSameMobile,				
				SourceFlag,
				]]>
				    <include refid="BINBEMQMES03.insertMemberInfoKeySql" />
					<include refid="BINOLCMINC99.insertKeySql" />
				<![CDATA[
			)
			VALUES
			(
				#organizationInfoID#,
				#brandInfoID#,
				#memName#,
				#memPhone#,
				#memMobile#,
				#memMail#,
				#regionID#,
				#birthYear#,
				#birthDay#,
				#memGranddate#,
				#memGranddate#,
				#employeeID#,
				#BAcode#,
				#organizationID#,
				#countercode#,
				'0',
				GETDATE(),
				#sourse#,
				#memberLevel#,
				#levelStatus#,
				#levelStartDate#,
				#levelEndDate#,
				#joinTime#,
				#referrerID#,
				#grantMemberLevel#,
				#levelAdjustDay#,
				#memAgeGetMethod#,
				#testType#,
				#version#,
				#memo1#,
				#memo2#,
				#active#,
				#activeDate#,
				#memberPassword#,
				#memGranddate#,
				#employeeID#,
				#BAcode#,
				#organizationID#,
				#countercode#,
				#tmallMixMobile#,				
				#bindFlag#,				
				#isSameMobile#,			
				#sourceFlag#,
				]]>
				    <include refid="BINBEMQMES03.insertMemberInfoValueSql" />
					<include refid="BINOLCMINC99.insertValueSql" />
				<![CDATA[
			)
			  	select SCOPE_IDENTITY() as value     
			]]> 
	    </selectKey>
	</insert>
	
	<!-- 插入会员持卡信息表 -->
	<insert id="addMemCardInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		INSERT INTO Members.BIN_MemCardInfo
		(
			BIN_MemberInfoID,
			MemCode,
			BaCode,
			CounterCode,
			GrantDate,
			GrantTime,
			CardValidFlag,
			CardCount,
			PointMoveFlag,
			]]>
				<include refid="BINOLCMINC99.insertKeySql" />
			<![CDATA[
		)
		VALUES
		(
			#memberInfoID#,
			]]>
			<isNotEmpty property="newMemcode">
				#newMemcode#,
			</isNotEmpty>
			<isEmpty property="newMemcode">
				#memberCode#,
			</isEmpty>
			<![CDATA[
			#tradeBAcode#,
			#tradeCounterCode#,
			]]>
			<isNotEmpty property="memChangeDate">
				#memChangeDate#,
				#memChangeTime#,
			</isNotEmpty>
			<isEmpty property="memChangeDate">
				#tradeGrantDate#,
				#tradeGrantTime#,
			</isEmpty>
			<![CDATA[
			'1',
			]]>
			<isNotEmpty property="cardCount">
				#cardCount#,
			</isNotEmpty>
			<isEmpty property="cardCount">
				'1',
			</isEmpty>
			<![CDATA[
			'1',
			]]>
				<include refid="BINOLCMINC99.insertValueSql" />
			<![CDATA[
		)
	]]>
	</insert>
	
	<!-- 插入会员地址表  -->
	<insert id="addMemberAddress" parameterClass="java.util.HashMap">
		<![CDATA[
			INSERT INTO Members.BIN_MemberAddress
			(
				BIN_MemberInfoID,
				BIN_AddressInfoID,
				BIN_AddressTypeID,
				DefaultFlag,
				]]>
					<include refid="BINOLCMINC99.insertKeySql" />
				<![CDATA[
			)	
			VALUES
			(
				#memberInfoID#,
				#addressInfoID#,
				'2',
				'1',
				]]>
					<include refid="BINOLCMINC99.insertValueSql" />
				<![CDATA[
			)
		]]>
	</insert>
	
	<!-- 插入地址信息表 -->
	<insert id="addAddressInfo" parameterClass="java.util.HashMap">
		<selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_AddressInfoID" >      
	        <![CDATA[
			INSERT INTO Basis.BIN_AddressInfo
			(
				AddressLine1,
				StandardCity,
				StandardProvince,
				StandardCounty,
				ZipCode,
				]]>
					<include refid="BINOLCMINC99.insertKeySql" />
				<![CDATA[
			)
			VALUES
			(
				#memAddress#,
				#cityID#,
				#provinceID#,
				#countyID#,
				#memPostcode#,
				]]>
					<include refid="BINOLCMINC99.insertValueSql" />
				<![CDATA[
			)
			  	select SCOPE_IDENTITY() as value    
			]]> 
	    </selectKey>
	</insert>
	
	<!-- 插入员工信息表 -->
	<insert id="addEmployee" parameterClass="java.util.HashMap">
		<selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_EmployeeID" >      
	       		<![CDATA[
			INSERT INTO Basis.BIN_Employee
			(
				BIN_OrganizationInfoID,
				BIN_BrandInfoID,
				BIN_OrganizationID,
				BIN_PositionCategoryID,
				NodeID,
				EmployeeCode,
				EmployeeName,
				MobilePhone,
				IdentityCard,
				]]>
					<include refid="BINOLCMINC99.insertKeySql" />
				<![CDATA[
			)
			VALUES
			(
				#organizationInfoID#,
				#brandInfoID#,
				#organizationID#,
				#positionCategoryID#,
				#newNodeId#,
				#BAcode#,
				#baname#,
				#baTel#,
				#identityCard#,
				]]>
					<include refid="BINOLCMINC99.insertValueSql" />
				<![CDATA[
			)
			  	select SCOPE_IDENTITY() as value     
			]]> 
	    </selectKey>
	</insert>
	
	<!-- 插入BA信息表 -->
	<insert id="addBaInfo" parameterClass="java.util.HashMap">
		<![CDATA[
			INSERT INTO Basis.BIN_BaInfo
			(
				BIN_OrganizationInfoID,
				BIN_BrandInfoID,
				BIN_EmployeeID,
				BIN_OrganizationID,
				BaCode,
				BaName,
				BaType,
				MobilePhone,
				IdentityCard,
				]]>
					<include refid="BINOLCMINC99.insertKeySql" />
				<![CDATA[
			)
			VALUES
			(
				#organizationInfoID#,
				#brandInfoID#,
				#employeeID#,
				#organizationID#,
				#BAcode#,
				#baname#,
				#flag#,
				#baTel#,
				#identityCard#,
				]]>
					<include refid="BINOLCMINC99.insertValueSql" />
				<![CDATA[
			)
		]]>
	</insert>
	
	<!-- 插入BAS考勤信息表 -->
	<insert id="addBasAttInfo" parameterClass="java.util.HashMap">
		<![CDATA[
			INSERT Monitor.BIN_BASAttendance
			(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                UdiskSN,
                BIN_EmployeeID,
                BIN_OrganizationID,
                MachineCode,
                AttendanceDate,
                ArriveTime,
				LeaveTime,
                AttendanceType,
				]]>
					<include refid="BINOLCMINC99.insertKeySql" />
				<![CDATA[
			)
			VALUES
			(
				#organizationInfoID#,
				#brandInfoID#,
				#UDiskSN#,
				#employeeID#,
				#organizationID#,
				#machinecode#,
				#attDate#,
				#arrTime#,
				]]>
				<isNotEmpty property="leaTime">
				  #leaTime#,
				</isNotEmpty>
			    <isEmpty property="leaTime">
			      null,
				</isEmpty>
				<![CDATA[
				#attType#,
				]]>
				<include refid="BINOLCMINC99.insertValueSql" />
				<![CDATA[
			)
		]]>
	</insert>
	
	<!-- 更新会员信息表 -->
	<update id="updMemberInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemberInfo
		SET
		    MemInfoRegFlg = 0,
		    ValidFlag = '1',  
	]]>	
		<isNotEmpty property="memName">
			Name = #memName#,
		</isNotEmpty>
		<isNotEmpty property="memPhone">
			Telephone = #memPhone#,
		</isNotEmpty>
		<isNotEmpty property="memMobile">
			MobilePhone = #memMobile#,
		</isNotEmpty>
		<isNotEmpty property="tmallMixMobile">
			TmallMixMobile = #tmallMixMobile#,
		</isNotEmpty>
		<isNotEmpty property="isSameMobile">
			IsSameMobile = #isSameMobile#,
		</isNotEmpty>
		<isNotEmpty property="memMail">
			Email = #memMail#,
		</isNotEmpty>
		<isNotEmpty property="regionID">
			BIN_RegionID = #regionID#,
		</isNotEmpty>
		<isNotEmpty property="birthYear">
			BirthYear = #birthYear#,
		</isNotEmpty>
		<isNotEmpty property="birthDay">
			BirthDay = #birthDay#,
		</isNotEmpty>
		<isNotEmpty property="employeeID">
			BIN_EmployeeID = #employeeID#,
		</isNotEmpty>
		<isNotEmpty property="BAcode">
			BaCodeBelong = #BAcode#,
		</isNotEmpty>
		<isNotEmpty property="organizationID">
			BIN_OrganizationID = #organizationID#,
		</isNotEmpty>
		<isNotEmpty property="countercode">
			CounterCodeBelong = #countercode#,
		</isNotEmpty>
		<isNotEmpty property="sourse">
			ChannelCode = case when MemInfoRegFlg=1 then #sourse# else ChannelCode end,
		</isNotEmpty>
		<isNotEmpty property="referrerID">
			ReferrerID = #referrerID#,
		</isNotEmpty>
		<isNotEmpty property="memAgeGetMethod">
			BirthYearGetType = #memAgeGetMethod#,
		</isNotEmpty>
		<isNotEmpty property="testType">
			TestType = #testType#,
		</isNotEmpty>
		<isNotEmpty property="memo1">
			Memo1 = #memo1#,
		</isNotEmpty>
		
		<isNotEmpty property="memo2">
			Memo2 = #memo2#,
		</isNotEmpty>
		<isNotEmpty property="version">
			Version = #version#,
		</isNotEmpty>
		<isNotEmpty property="jnDateKbn">
			<isEqual property="jnDateKbn" compareValue="1">
			<![CDATA[JoinDate = #memGranddate#,]]>
			</isEqual>
			<isEqual property="jnDateKbn" compareValue="2">
			<![CDATA[JoinDate = case when (JoinDate IS NULL) then #memGranddate# else JoinDate end,]]>
			</isEqual>
		</isNotEmpty>
		<isEmpty property="jnDateKbn">
			<![CDATA[JoinDate = #memGranddate#,]]>
		</isEmpty>
		<isNotEmpty property="initJnDateFlg">
			<isEqual property="initJnDateFlg" compareValue="0">
			<![CDATA[InitJoinDate = case when (InitJoinDate IS NULL) then #memGranddate# else InitJoinDate end,]]>
			</isEqual>
			<isEqual property="initJnDateFlg" compareValue="1">
			<![CDATA[InitJoinDate = #memGranddate#,]]>
			</isEqual>
		</isNotEmpty>
		<isNotEmpty property="joinTime">
			JoinTime = #joinTime#,
		</isNotEmpty>
        <isNotEmpty property="active">
            Active = #active#,
        </isNotEmpty>
        <isNotEmpty property="activeDate">
           	ActiveDate = #activeDate#,
        </isNotEmpty>
        <isNotEmpty property="memberLevel">
            MemberLevel = #memberLevel#,
        </isNotEmpty>
        <isNotEmpty property="levelStartDate">
        	LevelStartDate = #levelStartDate#,
        </isNotEmpty>
        <isNotEmpty property="levelEndDate">
        	LevelEndDate = #levelEndDate#,
        </isNotEmpty>
        <isNotEmpty property="genderCode">
            Gender = #genderCode#,
        </isNotEmpty>
        <isEmpty property="genderCode">
            Gender = NULL,
        </isEmpty>
        <isNotEmpty property="memberPassword">
			MemberPassword = #memberPassword#,
		</isNotEmpty>
        <isNotEmpty property="activeChannel">
            ActiveChannel = #activeChannel#,
        </isNotEmpty>
        <isNotEmpty property="tmallAccount">
            TmallAccount = #tmallAccount#,
        </isNotEmpty>
        <isNotEmpty property="messageId">
            MessageId = #messageId#,
        </isNotEmpty>
        <isNotEmpty property="firstUpTime">
            FirstUpTime = #firstUpTime#,
        </isNotEmpty>
        <isNotEmpty property="OrigUpFlg">
        	OrigJoinDate = #origJoinDate#,
        	OrigEmployeeID = #origEmployeeId#,
        	OrigBaCodeBelong = #origBaCode#,
        	OrigOrganizationID = #origOrganizationId#,
        	OrigCounterCodeBelong = #origCounterCode#,
        </isNotEmpty>
		<include refid="BINOLCMINC99.updateSql" />
	<![CDATA[
		WHERE
			BIN_MemberInfoID = #memberInfoID#
	]]>
	</update>
	
	<!-- 更新会员等级 -->
	<update id="updMemLevelInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemberInfo
		SET
		    MemberLevel = #memberLevel#,
		    LevelStatus = #levelStatus#,
		    GrantMemberLevel = #grantMemberLevel#,
		    LevelAdjustDay = #levelAdjustDay#,
	]]>
	<include refid="BINOLCMINC99.updateSql" />
	<![CDATA[
		WHERE
			BIN_MemberInfoID = #memberInfoID#
	]]>
	</update>
	
	<!-- 更新地址信息表-->
	<update id="updAddressInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Basis.BIN_AddressInfo
		SET
			AddressLine1 = #memAddress#,
			StandardCity = #cityID#,
			StandardProvince = #provinceID#,
			StandardCounty = #countyID#,
			ZipCode = #memPostcode#,
	]]>		
			<include refid="BINOLCMINC99.updateSql" />
	<![CDATA[
		WHERE
			BIN_AddressInfoID = #addressInfoID#	AND
			ValidFlag = '1'
	]]>
	</update>
	
	<!-- 删除旧会员卡 -->
	<update id="delOldMemberCard" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemCardInfo
		SET
			]]>
			CardValidFlag = '0',
			<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[
		WHERE
			BIN_MemberInfoID = #memberInfoID# AND
			ValidFlag = '1'	
	]]>
	</update>
	
	<!-- 删除旧BA信息(员工表) -->
	<delete id="delOldBaFromEmployeeTable" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM	
			Basis.BIN_Employee
		WHERE
			BIN_OrganizationInfoID = #organizationInfoID# AND
			BIN_BrandInfoID = #brandInfoID# AND
			BIN_OrganizationID = #organizationID# AND
			BIN_PositionCategoryID = #baPositionID#
	]]>
	</delete>
	
	<!-- 根据BAcode删除旧BA信息(员工表) -->
	<delete id="delOldBaFromEmployeeByBaCode" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM	
			Basis.BIN_Employee
		WHERE
			BIN_OrganizationInfoID = #organizationInfoID# AND
			BIN_BrandInfoID = #brandInfoID# AND
			EmployeeCode = #BAcode#
	]]>
	</delete>
	
	<!-- 删除旧BA信息(营业员信息表) -->
	<delete id="delOldBaFromBaInfoTable" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Basis.BIN_BaInfo
		WHERE
			BIN_OrganizationInfoID = #organizationInfoID# AND
			BIN_BrandInfoID = #brandInfoID# AND
			BIN_OrganizationID = #organizationID# AND
			BaType = '1'
	]]>
	</delete>
	
	<!-- 根据BAcode删除旧BA信息(营业员信息表) zhhuyi-->
	<delete id="delOldBaFromBaInfoByBaCode" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Basis.BIN_BaInfo
		WHERE
			BIN_OrganizationInfoID = #organizationInfoID# AND
			BIN_BrandInfoID = #brandInfoID# AND
			BaCode = #BAcode# AND
			BaType = '1'
	]]>
	</delete>
	
	<!-- 查询会员信息数据 -->
	<select id="selMemberInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
			A.BIN_MemberInfoID AS memberInfoID,
			A.MemInfoRegFlg AS memInfoRegFlg,
			A.Version AS oldVersion,
			ISNULL(A.MemberLevel, 0) AS preMemLevel,
			B.CardValidFlag AS cardValidFlag,
			B.CardCount AS cardCount,
			C.BIN_AddressInfoID AS addressInfoID
		FROM
			Members.BIN_MemberInfo A
			JOIN Members.BIN_MemCardInfo B ON A.BIN_MemberInfoID = B.BIN_MemberInfoID AND B.ValidFlag = '1'
			LEFT JOIN Members.BIN_MemberAddress C ON A.BIN_MemberInfoID = C.BIN_MemberInfoID AND C.ValidFlag = '1'
		WHERE
			A.BIN_OrganizationInfoID = #organizationInfoID# AND
			A.BIN_BrandInfoID = #brandInfoID# AND
			B.MemCode = #memberCode#
	</select>
	
	<!-- 查询区域省ID和市ID -->
	<select id="selProvinceCityID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
		SELECT
			A.BIN_RegionID AS provinceID,
			B.BIN_RegionID AS cityID
		FROM
			Basis.BIN_StandardRegion A
			JOIN Basis.BIN_StandardRegion B ON B.NodeID.IsDescendantOf(A.NodeID) = 1
		WHERE
		]]>	
		<isNotEmpty property="memProvince">	
			A.RegionNameChinese LIKE '%' + #memProvince# + '%' AND
		</isNotEmpty>	
		<![CDATA[
			B.RegionNameChinese LIKE '%' + #memCity# + '%' AND
			A.NodeID != B.NodeID AND
			A.RegionType = '1' AND
			A.ValidFlag = '1' AND
			B.ValidFlag = '1'
		]]>	
	</select>
	
	<!-- 查询区域省ID -->
	<select id="selProvinceID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
		SELECT
			A.BIN_RegionID AS provinceID
		FROM
			Basis.BIN_StandardRegion A
		WHERE
			A.RegionNameChinese LIKE '%' + #memProvince# + '%' AND
			A.RegionType = '1' AND
			A.ValidFlag = '1'
		]]>		
	</select>
	
	<!-- 查询新节点NodeID -->
	<select id="selNewNodeID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT 
				CONVERT(hierarchyid,'/').GetDescendant(max(NodeID), NULL).ToString() AS newNodeId
        	FROM 
        		Basis.BIN_Employee
            WHERE 
            	NodeID.GetAncestor(1)='/'
		]]>
	</select>
	
	<!-- 查询岗位类别 -->
	<select id="selPositionCategoryList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
			A.BIN_PositionCategoryID AS positionCategoryID,
			A.CategoryCode AS categoryCode
		FROM
			Privilege.BIN_PositionCategory A
		WHERE
			A.BIN_OrganizationInfoID = #organizationInfoID# AND
			A.BIN_BrandInfoID = #brandInfoID# AND
			A.ValidFlag = '1' AND
			(CategoryCode = '01' OR CategoryCode = '02') 
	</select>
	
		<!-- 查询会员  判断是否是重复的数据-->
	<select id ="selMemberIsRepeatData" parameterClass="java.util.HashMap" resultClass ="java.lang.Integer">
		<![CDATA[
        select 
		     count(*) AS num
		from 
		     Members.BIN_MemberInfo A
        where 
		     A.BIN_BrandInfoID = #brandInfoID# AND
             A.BIN_OrganizationInfoID = #organizationInfoID#  AND
             A.MemInfoRegFlg='0' AND
             A.JoinDate=#memGranddate#
		]]>	
		<isNotEmpty property="memPhone">
			AND Telephone = #memPhone#
		</isNotEmpty>
		<isNotEmpty property="memMobile">
			AND MobilePhone = #memMobile#
		</isNotEmpty>
	</select>
	
	 <!-- 查询营业员所在柜台的柜台主管 -->
	<select id="selSuperPath" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT 
			    A.BIN_EmployeeID AS employeeID,
				B.Path AS superPath
			FROM 
				Privilege.BIN_EmployeeDepart A,
				Basis.BIN_Employee B
			WHERE
				A.BIN_EmployeeID = B.BIN_EmployeeID AND
				B.BIN_OrganizationInfoID = #organizationInfoID# AND
			    B.BIN_BrandInfoID = #brandInfoID# AND
				A.ManageType = '1' AND
				A.BIN_OrganizationID = #organizationID#
		]]>
    </select>	
		<!-- 查询子节点NodeID -->
	<select id="selChildNodeID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT 
				CONVERT(hierarchyid,#superPath#).GetDescendant(max(NodeID), NULL).ToString() AS newNodeId
        	FROM 
        		Basis.BIN_Employee
            WHERE 
            	NodeID.GetAncestor(1)=#superPath#
		]]>
	</select>	
	
	<!-- 查询U盘对应的员工信息 -->
	<select id="selUdiskInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
      <![CDATA[
		  SELECT
		      A.BIN_EmployeeID AS employeeID,
			   A.EmployeeName AS employeeName,
			  A.EmployeeCode AS employeeCode,
		      C.CategoryCode AS categoryCode,
		      C.CategoryName AS categoryName
		  FROM 
		      Basis.BIN_Employee A    
			  join    
			  Monitor.BIN_UdiskInfo B   
		      on  
			  A.BIN_EmployeeID = B.BIN_EmployeeID
		      left join   
			  Privilege.BIN_PositionCategory C 
			  on 
			  A.BIN_PositionCategoryID = C.BIN_PositionCategoryID
		  WHERE 
		      B.BIN_BrandInfoID = #brandInfoID# AND
		      B.BIN_OrganizationInfoID = #organizationInfoID# AND
		      B.UdiskSN=#UDiskSN# AND
			  B.OwnerRight>0 AND
		      B.ValidFlag='1' AND
		      A.ValidFlag='1'
		]]>
	</select>
	
	<!-- 查询BAS考勤信息表 -->
	<select id="selBasAttInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
      <![CDATA[
		 select 
              A.BIN_BASAttendanceID AS BASAttendanceID
         from 
              Monitor.BIN_BASAttendance A
         where 
		 	  A.BIN_OrganizationInfoID = #organizationInfoID# AND
		      A.BIN_BrandInfoID = #brandInfoID# AND
              A.UdiskSN=#UDiskSN# AND 
              A.ArriveTime =#arrTime# AND 
			  A.ValidFlag = '1'
		]]>
	</select>
	
		<!-- 更新BAS考勤信息表-->
	<update id="updBasAttInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Monitor.BIN_BASAttendance 
		SET
			]]>
			<isNotEmpty property="leaTime">
				LeaveTime = #leaTime#,
			    AttendanceType = '0',
			</isNotEmpty>

			<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[
		WHERE
			BIN_OrganizationInfoID = #organizationInfoID# AND
		    BIN_BrandInfoID = #brandInfoID# AND
            UdiskSN = #UDiskSN# AND 
            ArriveTime = #arrTime# AND 
			ValidFlag = '1'
	]]>
	</update>
	
	<!-- 查询员工信息及对应的岗位 -->
	<select id="selEmpAndPosinfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
      <![CDATA[
			SELECT 
			     A.BIN_EmployeeID AS employeeID,
			     A.EmployeeName AS  employeeName,
			     B.CategoryCode AS  categoryCode,
			     B.CategoryName AS  categoryName
			FROM
				 Basis.BIN_Employee A
				 LEFT JOIN 
				 Privilege.BIN_PositionCategory B ON A.BIN_PositionCategoryID = B.BIN_PositionCategoryID
			WHERE 
			     A.BIN_OrganizationInfoID = #organizationInfoID# AND
			     A.BIN_BrandInfoID = #brandInfoID# AND
			     A.EmployeeCode = #BAcode#
		]]>
	</select>
	<!-- 查询会员等级信息 -->
	<select id="selMemberLevel" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
      <![CDATA[
		    SELECT 
		         B.BIN_MemberLevelID  AS memLevel
		    FROM  
			     Members.BIN_MemberLevel B
		    WHERE
			     B.BIN_BrandInfoID = #brandInfoID# AND
		         B.BIN_OrganizationInfoID = #organizationInfoID# AND
		         B.LevelCode=#memLevel# AND
		         B.ValidFlag='1'
		]]>
	</select>
	<!-- 查询bas考勤  判断是否是重复的数据 -->
	<select id="selBasIsRepeatData" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
      <![CDATA[
           SELECT 
		         COUNT(*) AS num
           FROM 
		         Monitor.BIN_BASAttendance A
           WHERE 
		   	     A.BIN_OrganizationInfoID = #organizationInfoID# AND
			     A.BIN_BrandInfoID = #brandInfoID# AND
		         A.UdiskSN = #UDiskSN# AND (
                 A.ArriveTime=#arrTime# or A.LeaveTime = #leaTime#) AND
                 A.ValidFlag = '1'
		]]>
	</select>
	
	<!--更新员工信息表 -->
	<update id="updateEmployee" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE				
				Basis.BIN_Employee			
			SET
			]]>
			<isNotEmpty property="BAcode">
                EmployeeCode = #BAcode#,
			</isNotEmpty>
			<isNotEmpty property="baname">
			    EmployeeName = #baname#,
			</isNotEmpty>
			<isNotEmpty property="baTel">
			    MobilePhone = #baTel#,
			</isNotEmpty>
            <isNotEmpty property="identityCard">
                IdentityCard = #identityCard#,
            </isNotEmpty>
			<isNotEmpty property="newNodeId">
			 	NodeID = #newNodeId#,
			</isNotEmpty>
			<![CDATA[
				BIN_OrganizationID = #organizationID#,
				ValidFlag = '1',
			
		]]>
			<include refid="BINOLCMINC99.updateSql" />		
		<![CDATA[				
			WHERE					
				BIN_EmployeeID = #employeeID#
		]]>
    </update>	
	
	 <!--查询营业员信息 -->
	<select id="selBaInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT 						
				BIN_BaInfoID AS baInfoID,
				BIN_EmployeeID AS employeeID			
			FROM						
				Basis.BIN_BaInfo				
			WHERE						
				BIN_OrganizationInfoID = #organizationInfoID# AND
				BIN_BrandInfoID = #brandInfoID# AND
				BaCode = #BAcode#
		]]>
    </select>
	
	<!--更新营业员信息表 -->
	<update id="updateBaInfo" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE				
				Basis.BIN_BaInfo			
			SET				
			]]>
			<isNotEmpty property="baname">
				BaName = #baname#,
			</isNotEmpty>
			<isNotEmpty property="baTel">
				MobilePhone = #baTel#,
			</isNotEmpty>
            <isNotEmpty property="identityCard">
                IdentityCard = #identityCard#,
            </isNotEmpty>
			<![CDATA[
				BIN_OrganizationID = #organizationID#,
				ValidFlag = '1',
		]]>
			<include refid="BINOLCMINC99.updateSql" />		
		<![CDATA[				
			WHERE					
				BIN_BaInfoID = #baInfoID#
		]]>
    </update>
	
	<!-- 查询员工信息 -->
	<select id ="selEmployeeInfo" parameterClass="java.util.HashMap" resultClass ="java.util.HashMap">
		SELECT
			A.BIN_EmployeeID AS employeeID,
			A.BIN_OrganizationID AS organizationID,
			A.Path AS path,
			A.ValidFlag AS validFlag
		FROM
			Basis.BIN_Employee A
		WHERE
			A.BIN_OrganizationInfoID = #organizationInfoID# AND
			A.BIN_BrandInfoID = #brandInfoID# AND
		<isNotEmpty property="organizationID">
			A.BIN_OrganizationID  = #organizationID# AND
		</isNotEmpty>
			A.EmployeeCode = #BAcode#
	</select>
	
	<!-- 查询员工信息（用员工名字查）-->
    <select id ="selEmployeeInfoByName" parameterClass="java.util.HashMap" resultClass ="java.util.HashMap">
	    <![CDATA[
	        SELECT
	            A.BIN_EmployeeID AS employeeID,
	            A.BIN_OrganizationID AS organizationID,
	            A.Path AS path
	        FROM
	            Basis.BIN_Employee A
	        WHERE
	            A.BIN_OrganizationInfoID = #organizationInfoID#
	            AND A.BIN_BrandInfoID = #brandInfoID#
                AND A.EmployeeName = #BAcode#
                AND A.ValidFlag = '1'
        ]]>
    </select>
	
    <!-- 查询BAS下属员工信息 -->
	<select id ="selEmployeesByBAS" parameterClass="java.util.HashMap" resultClass ="java.util.HashMap">
		SELECT
		    DISTINCT					
			X.BIN_EmployeeID AS employeeID,	
			X.EmployeeCode AS employeeCode,		 		
			X.Path AS path,
			X.ValidFlag AS validFlag
		FROM						
			Basis.BIN_Employee Z,
			Basis.BIN_Employee X
		WHERE						
			X.NodeID.GetAncestor(1) = Z.NodeID AND
			Z.BIN_EmployeeID = #employeeID# 
	</select>
	
	<!-- 查询BA的原上级BAS -->
    <select id="getOldBASList" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		<![CDATA[
			SELECT DISTINCT
				B.BIN_EmployeeID AS employeeId
			FROM 
				Basis.BIN_Employee A,
				Basis.BIN_Employee B
			WHERE
				A.NodeID.GetAncestor(1) = B.NodeID AND
				A.BIN_OrganizationInfoID = #organizationInfoID# AND
				A.BIN_BrandInfoID = #brandInfoID# AND
				A.EmployeeCode IN
		]]>
			<iterate property="detailDataDTOList" open="(" close=")" conjunction=","> 
				#detailDataDTOList[].BAcode#
			</iterate>
    </select>
    
    <!-- 查询关注BA的员工 -->
    <select id="getLikeBAList" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		<![CDATA[
			SELECT DISTINCT
				B.BIN_EmployeeID AS employeeId
			FROM 
				Basis.BIN_Employee A,
				Privilege.BIN_LikeEmployee B
			WHERE
				A.BIN_EmployeeID = B.BIN_LikeEmployeeID AND
				A.BIN_OrganizationID <> #organizationID# AND
				A.BIN_OrganizationInfoID = #organizationInfoID# AND
				A.BIN_BrandInfoID = #brandInfoID# AND
				A.EmployeeCode IN
		]]>
			<iterate property="detailDataDTOList" open="(" close=")" conjunction=","> 
				#detailDataDTOList[].BAcode#
			</iterate>
    </select>
	
	<!--对该柜台下的所有BA对应的员工信息中的部门ID设置为空 -->
	<update id="updEmpOrgIdISNull" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE 
			     Basis.BIN_Employee
		    SET 
		         BIN_OrganizationID = NULL,
		]]>
			<include refid="BINOLCMINC99.updateSql" />		
		<![CDATA[				
		   WHERE 
			    BIN_OrganizationID=#organizationID# AND 
				BIN_OrganizationInfoID = #organizationInfoID# AND
				BIN_BrandInfoID = #brandInfoID# AND
		 	    BIN_PositionCategoryID = #baPositionID#
			  ]]>
    </update>
	
	<!-- 查询部门子节点NodeID -->
	<select id="selOrgChildNodeID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT 
				CONVERT(hierarchyid,#superPath#).GetDescendant(max(NodeID), NULL).ToString() AS newNodeId
        	FROM 
        		Basis.BIN_Organization
            WHERE 
            	NodeID.GetAncestor(1)=#superPath#
		]]>
	</select>	
	<!--更新该部门对应的上级path -->
	<update id="updOrgNodeID" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE 
			     Basis.BIN_Organization
		    SET 
		         NodeID = #newNodeId#,
		]]>
			<include refid="BINOLCMINC99.updateSql" />		
		<![CDATA[				
		   WHERE 
			    BIN_OrganizationID=#organizationID# AND 
				BIN_OrganizationInfoID = #organizationInfoID# AND
				BIN_BrandInfoID = #brandInfoID# 
			  ]]>
    </update>
	
	<!-- 查询部门所属上级部门ID -->
	<select id="selOrgSuperOrgID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
		    SELECT 
                DISTINCT
				B.BIN_OrganizationID,
				B.Path 
			FROM 
				Basis.BIN_Organization A,
				Basis.BIN_Organization B
			WHERE
				A.NodeID.GetAncestor(1) = B.NodeID AND
				A.BIN_OrganizationInfoID = #organizationInfoID# AND
				A.BIN_BrandInfoID = #brandInfoID# AND
			    A.BIN_OrganizationID = #organizationID#
		]]>
	</select>	
	<!-- 查询部门所属上级部门Path -->
	<select id="selOrgSuperOrgPath" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
		   select 
		       A.Path AS superPath
		   from 
		       Basis.BIN_Organization A 
		   where 
			   A.BIN_OrganizationID = #organizationID#
		]]>
	</select>	
	
	<!-- 插入会员回访信息表 -->
	<insert id="InsertMemVisitInfo" parameterClass="java.util.HashMap">
		<![CDATA[
		   INSERT INTO  Members.BIN_MemberVisit(
		        BIN_OrganizationInfoID,
		        BIN_BrandInfoID,
	 	        BIN_OrganizationID,
		        BIN_EmployeeID,
		        BIN_MemberInfoID,
		        BIN_VisitTaskID,
		        VisitBeginTime,
		        VisitEndTime,
		        VisitTime,
		        VisitFlag,
		        VisitCode,
		        VisitTypeCode,
		        VisitWay,
		        Sourse,
		        Comments,
				CreateTime,
				UpdateTime,
				CreatedBy,
				CreatePGM,
				UpdatedBy,
				UpdatePGM,
				ModifyCount
	        )
			VALUES
			(
				#organizationInfoID#,
				#brandInfoID#,
				#organizationID#,
				#employeeID#,
				#memberInfoID#,
				#visitTaskID#,
				#visitBeginDate#,
				#visitEndDate#,
				#visitDate#,
				#visitFlag#,
				#visitCode#,
				#visitTypeCode#,
				#visitWay#,
				#sourse#,
				#comments#,
				]]>
				<isNotEmpty property="createTime">
					#createTime#,
				</isNotEmpty>
				<isEmpty property="createTime">
					GETDATE(),
				</isEmpty>
				<isNotEmpty property="createTime">
					#createTime#,
				</isNotEmpty>
				<isEmpty property="createTime">
					GETDATE(),
				</isEmpty>
			   <![CDATA[
				#createdBy#,
				#createPGM#,
				#updatedBy#,
				#updatePGM#,
				'0'
			)
		]]>
	</insert>
	
	<!--更新会员回访信息      新后台-->
	<update id="updateMemVitInfo" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
			      Members.BIN_MemberVisit
			SET
			      VisitBeginTime=#visitBeginDate#,
			      VisitEndTime=#visitEndDate#,
			      VisitTime=#visitDate#,
			      VisitFlag=#visitFlag#,
		 ]]>
			      UpdateTime=GETDATE(),
		 <![CDATA[
			      UpdatedBy='BATCH',
			      UpdatePGM='BATCH',
			      ModifyCount=ModifyCount+1
			WHERE 
		]]>	
				  <isNotEmpty property="visitTaskID">
				  BIN_VisitTaskID = #visitTaskID# AND
				  BIN_BrandInfoID=#brandInfoID# AND
				  BIN_OrganizationInfoID=#organizationInfoID#
				  </isNotEmpty>
				  <isEmpty property="visitTaskID">
				  BIN_MemberInfoID=#memberInfoID# AND
				  VisitCode = #visitCode# AND
				  VisitTypeCode=#visitTypeCode# AND
				  BIN_BrandInfoID=#brandInfoID# AND
				  BIN_OrganizationInfoID=#organizationInfoID#	
				  </isEmpty>
    </update>
	
	<!-- 把新会员卡号合并到老会员卡号中 -->
	<update id="updNewMemberCardInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemCardInfo
		SET
			BIN_MemberInfoID = #memberInfoID#,
			CardCount = CardCount+#cardCount#,
	]]>		
			<include refid="BINOLCMINC99.updateSql" />
	<![CDATA[
		WHERE
			BIN_MemberInfoID=#newMemberInfoID# AND
			ValidFlag = '1'
	]]>
	</update>
	
	<!--把新会员对应的销售记录的会员ID更新成老会员对应的会员ID-->
	<update id="updateSaleMemId" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Sale.BIN_SaleRecord
			SET
				BIN_MemberInfoID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID=#newMemberInfoID#							
		]]>
    </update>
    
    <!--把新会员对应的活动履历记录的会员ID更新成老会员对应的会员ID-->
	<update id="updateCampaignHistoryMemId" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Campaign.BIN_CampaignHistory
			SET
				BIN_MemberInfoID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID=#newMemberInfoID#							
		]]>
    </update>
    
    <!--把新会员对应的会员使用化妆次数积分明细记录的会员ID更新成老会员对应的会员ID-->
	<update id="updateMemUsedMemId" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Members.BIN_MemUsedDetail
			SET
				BIN_MemberInfoID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID=#newMemberInfoID#							
		]]>
    </update>
    
    <!--把新会员对应的规则执行履历记录的会员ID更新成老会员对应的会员ID-->
	<update id="updateRuleRecordMemId" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Members.BIN_RuleExecRecord
			SET
				BIN_MemberInfoID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID = #newMemberInfoID#							
		]]>
    </update>
    
    <!-- 删除新会员信息 -->
	<delete id="delNewMemberInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Members.BIN_MemberInfo
		WHERE
			BIN_MemberInfoID = #newMemberInfoID#
	]]>
	</delete>
	
	<!-- 查询新卡对应的会员信息数据 -->
	<select id="selMemInfoByNewMemcode" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
			A.BIN_MemberInfoID AS newMemberInfoID,
			A.Name AS memName,
			A.Telephone AS memPhone,
			A.MobilePhone AS memMobile,
			A.JoinDate AS memGranddate,
			A.Gender AS genderCode,
			A.BIN_RegionID AS regionID,
			A.BirthYear AS birthYear,
			A.BirthDay AS birthDay,
			A.Email AS memMail,
			A.BIN_EmployeeID AS employeeID,
			A.BaCodeBelong AS BAcode,
			A.BIN_OrganizationID AS organizationID,
			A.CounterCodeBelong AS countercode,
			A.ChannelCode AS sourse,
			A.ReferrerID AS referrerID,
			A.BirthYearGetType AS memAgeGetMethod,
			A.TestType AS testType,
			A.Version AS version,
			A.Memo1 AS memo1,
			A.Memo2 AS memo2,
			A.Active AS active,
			A.ActiveDate AS activeDate,
			A.MemberLevel AS memberLevel,
			A.MemInfoRegFlg AS memInfoRegFlg,
			A.MessageId AS messageId,
			B.CardValidFlag AS cardValidFlag,
			C.BIN_AddressInfoID AS newAddressInfoID,
			D.AddressLine1 AS memAddress,
			D.StandardCity AS cityID,
			D.StandardProvince AS provinceID,
			D.StandardCounty AS countyID,
			D.ZipCode AS memPostcode
		FROM
			Members.BIN_MemberInfo A
			JOIN Members.BIN_MemCardInfo B ON A.BIN_MemberInfoID = B.BIN_MemberInfoID AND B.ValidFlag = '1' 
			LEFT JOIN Members.BIN_MemberAddress C 
				JOIN Basis.BIN_AddressInfo D ON C.BIN_AddressInfoID = D.BIN_AddressInfoID AND D.ValidFlag = '1'
			ON C.BIN_MemberInfoID = A.BIN_MemberInfoID AND C.ValidFlag = '1'
		WHERE
			A.BIN_OrganizationInfoID = #organizationInfoID# AND
			A.BIN_BrandInfoID = #brandInfoID# AND
			B.MemCode = #newMemcode#
	</select>
	
	<!-- 插入重算信息表  -->
	<insert id="insertReCalcInfo" parameterClass="java.util.HashMap">	
		<![CDATA[
	   INSERT INTO Members.BIN_ReCalcInfo
			      (BIN_OrganizationInfoID,
				   BIN_BrandInfoID,
				   BIN_MemberInfoID,
				   MemCode,												
			       ReCalcType,												
			       ReCalcDate,
			       BIN_MemberClubID,		
		]]>
			<include refid="BINOLCMINC99.insertKeySql" />									
		<![CDATA[								
		)VALUES									
				 (#organizationInfoID#,
				  #brandInfoID#,
				  #memberInfoID#,
				  #newMemcode#,					
                  #reCalcType#,					
                  #reCalcDate#,
                  #memberClubID#,
		]]>
		    <include refid="BINOLCMINC99.insertValueSql" />
		<![CDATA[)]]>
	</insert> 
	
	<!-- 查询新卡对应的会员产生的最早业务时间 -->
	<select id="getMinTicketDate" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		<![CDATA[
			SELECT TOP 1
				CONVERT(varchar(30), TicketDate, 121)
			FROM
				Members.BIN_RuleExecRecord
			WHERE
				BIN_MemberInfoID = #newMemberInfoID# AND
				BIN_BrandInfoID = #brandInfoID# AND
				BIN_OrganizationInfoID = #organizationInfoID# AND
				ValidFlag = '1'
			 ORDER BY
			 	TicketDate 
		]]>	
    </select>
    
    <!-- 更新会员卡状态 -->
	<update id="updMemberCardStatus" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemCardInfo
		SET
			]]>
			CardValidFlag = #cardValidFlagUpd#,
			<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[
		WHERE
			BIN_MemberInfoID = #memberInfoID# AND
			MemCode = #memberCode# AND
			ValidFlag = '1'	
	]]>
	</update>
	
	 <!-- 更新会员状态 -->
	<update id="updMemValidFlag" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemberInfo
		SET
			ValidFlag = #memValidFlag#,
		]]>
			<include refid="BINOLCMINC99.updateSql" />
		<![CDATA[
		WHERE
			BIN_MemberInfoID = #memberInfoID#
	]]>
	</update>
	
	<!-- 查询会员的有效卡数量 -->
	<select id="getMemCardCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		<![CDATA[
			SELECT
				COUNT(*)
			FROM
				Members.BIN_MemCardInfo
			WHERE
				BIN_MemberInfoID = #memberInfoID# AND
				CardValidFlag = '1' AND
				ValidFlag = '1'
		]]>	
    </select>
    
    <!-- 更新会员卡信息 -->
	<update id="updMemberCardInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE
			Members.BIN_MemCardInfo
		SET
			BaCode=CASE WHEN BaCode IS NULL THEN #tradeBAcode# ELSE BaCode END,
			CounterCode=CASE WHEN CounterCode IS NULL THEN #tradeCounterCode# ELSE CounterCode END,
			CardValidFlag = #cardValidFlagUpd#,
	]]>	
		<isNotEmpty property="memChangeDate">
			GrantDate = #memChangeDate#,
			GrantTime = #memChangeTime#,
		</isNotEmpty>
		<isEmpty property="memChangeDate">
			<isNotEmpty property="tradeGrantDate">
				GrantDate = case when ISNULL(GrantDate,'')='' then #tradeGrantDate# else GrantDate end,
			</isNotEmpty>
			<isNotEmpty property="tradeGrantTime">
				GrantTime = case when ISNULL(GrantTime,'')='' then #tradeGrantTime# else GrantTime end,
			</isNotEmpty>
		</isEmpty>		
		<include refid="BINOLCMINC99.updateSql" />
	<![CDATA[
		WHERE
			BIN_MemberInfoID = #memberInfoID# AND
			MemCode = #memberCode# AND
			ValidFlag = '1'	
	]]>
	</update>
	
	<!-- 查询推荐会员ID -->
	<select id="selReferrerID" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
			A.BIN_MemberInfoID AS referrerID
		FROM
			Members.BIN_MemberInfo A
			JOIN Members.BIN_MemCardInfo B ON A.BIN_MemberInfoID = B.BIN_MemberInfoID AND B.ValidFlag = '1' 
		WHERE
			A.BIN_OrganizationInfoID = #organizationInfoID# AND
			A.BIN_BrandInfoID = #brandInfoID# AND
			B.MemCode = #referrer#
	</select>
	
	<!-- 查询新会员对应的答卷信息 -->
	<select id="getNewMemPaperAnswer" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
			A.BIN_PaperAnswerID
		FROM
			Monitor.BIN_PaperAnswer A
		WHERE
			A.BIN_MemberInfoID = #newMemberInfoID# AND
			A.ValidFlag = '1'
	</select>
	
	<!--把老会员对应的答卷信息更新成无效-->
	<update id="updatePaperAnswerValid" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Monitor.BIN_PaperAnswer
			SET
				ValidFlag='0',
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID=#memberInfoID#							
		]]>
    </update>
	
	<!--把新会员对应的答卷信息的会员ID更新成老会员对应的会员ID-->
	<update id="updatePaperAnswer" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Monitor.BIN_PaperAnswer
			SET
				BIN_MemberInfoID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID=#newMemberInfoID#							
		]]>
    </update>
    
    <!-- 删除新会员扩展信息 -->
	<delete id="delNewMemberExtInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Members.BIN_MemberExtInfo
		WHERE
			BIN_MemberInfoID = #newMemberInfoID#
	]]>
	</delete>
	
	<!--把新会员对应的推荐会员ID更新成老会员对应的会员ID-->
	<update id="updateReferrerID" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Members.BIN_MemberInfo
			SET
				ReferrerID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				ReferrerID=#newMemberInfoID#							
		]]>
    </update>
    
    <!-- 删除地址信息 -->
	<delete id="delAddressInfo" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Basis.BIN_AddressInfo
		WHERE
			BIN_AddressInfoID = #newAddressInfoID#
	]]>
	</delete>
	
	<!-- 删除新会员地址信息 -->
	<delete id="delNewMemberAddress" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Members.BIN_MemberAddress
		WHERE
			BIN_MemberInfoID = #newMemberInfoID#
	]]>
	</delete>
	
	<!-- 删除新会员积分信息 -->
	<delete id="delNewMemberPoint" parameterClass="java.util.HashMap">
	<![CDATA[
		DELETE FROM
			Members.BIN_MemberPoint
		WHERE
			BIN_MemberInfoID = #newMemberInfoID#
	]]>
	</delete>
	
	<!--把新会员对应的积分变化记录的会员ID更新成老会员对应的会员ID-->
	<update id="updatePointChangeMemId" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE
				Members.BIN_PointChange
			SET
				BIN_MemberInfoID=#memberInfoID#,
			]]>
				<include refid="BINOLCMINC99.updateSql" />
			<![CDATA[	      
			WHERE 
				BIN_MemberInfoID = #newMemberInfoID#							
		]]>
    </update>
    
    <!-- 查询会员的最新卡号 -->
	<select id="getCurMemCode" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		<![CDATA[
			SELECT TOP 1
				MemCode
			FROM
				Members.BIN_MemCardInfo
			WHERE
				BIN_MemberInfoID = #memberInfoID# AND
				ValidFlag = '1'
			ORDER BY
				CardValidFlag DESC,
				CardCount DESC	
		]]>	
    </select>
    
    
    <!-- 查询会员的最早销售时间 -->
	<select id="getMinSaleTime" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		<![CDATA[
		SELECT 
			MIN(T.SaleTime) AS saleTime
		FROM(
			SELECT
				convert(varchar, MIN(SaleTime), 120) AS SaleTime
			FROM
				Sale.BIN_SaleRecord
			WHERE
				BIN_MemberInfoID = #memberInfoID# AND
	]]>	
	<isNotEmpty property="memberClubID">
			BIN_MemberClubID = #memberClubID# AND
	</isNotEmpty>
	<![CDATA[
			(BillModel IS NULL OR  BillModel IN ('0','1','3','4')) AND
			(IsPoint IS NULL OR IsPoint <> '0') AND
			ValidFlag = '1'
	UNION
		SELECT
			convert(varchar, MIN(BillCreateTime), 120) AS SaleTime
		FROM 
			Sale.BIN_ESOrderMain WITH(nolock)
		WHERE 
			BIN_MemberInfoID = #memberInfoID# AND
		 	BillType = '2' AND
		 	ValidFlag = '1'
	) T
		]]>	
    </select>
    
    <!-- 插入会员回访表 -->
    <insert id="insertMemberVisit" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO  Members.BIN_MemberVisit(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                BIN_OrganizationID,
                BIN_EmployeeID,
                BIN_MemberInfoID,
                BIN_VisitTaskID,
                BIN_PaperAnswerID,
                VisitBeginTime,
                VisitEndTime,
                VisitTime,
                VisitFlag,
                VisitCode,
                VisitTypeCode,
                VisitWay,
                Sourse,
                Comments,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )
            VALUES
            (
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #BIN_OrganizationID#,
                #BIN_EmployeeID#,
                #BIN_MemberInfoID#,
                #BIN_VisitTaskID#,
                #BIN_PaperAnswerID#,
                #VisitBeginTime#,
                #VisitEndTime#,
                #VisitTime#,
                #VisitFlag#,
                #VisitCode#,
                #VisitTypeCode#,
                #VisitWay#,
                #Sourse#,
                #Comments#,
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </insert>
    
    <!-- 插入答卷主表 -->
    <insert id="insertPaperAnswer" parameterClass="java.util.HashMap">
        <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_PaperAnswerID" >
            <![CDATA[
                INSERT INTO Monitor.BIN_PaperAnswer(
                    BIN_PaperID,
                    BIN_OrganizationID,
                    PaperType,
                    BACode,
                    BIN_MemberInfoID,
            ]]>
            <include refid="BINOLCMINC99.insertKeySql" />
            <![CDATA[
                )
                VALUES
                (
                    #BIN_PaperID#,
                    #BIN_OrganizationID#,
                    #PaperType#,
                    #BACode#,
                    #BIN_MemberInfoID#,
            ]]>
            <include refid="BINOLCMINC99.insertValueSql" />
            <![CDATA[
                )
                select SCOPE_IDENTITY() as value
            ]]> 
        </selectKey>
    </insert>
    
    <!-- 插入答卷明细表  -->
    <insert id="insertPaperAnswerDetail" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO Monitor.BIN_PaperAnswerDetail(
                BIN_PaperAnswerID,
                BIN_PaperQuestionID,
                Answer,
        ]]>
        <include refid="BINOLCMINC99.insertKeySql" />
        <![CDATA[
            )
            VALUES
            (
                #BIN_PaperAnswerID#,
                #BIN_PaperQuestionID#,
                #Answer#,
        ]]>
        <include refid="BINOLCMINC99.insertValueSql" />
        <![CDATA[
            )
        ]]>
    </insert>
    
    <!-- 更新回访任务表 -->
    <update id="updateVisitTask" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Members.BIN_VisitTask
            SET
                TaskState = '2',
                VisitTime = #VisitTime#,
                VisitResult = #VisitResult#,
                BIN_PaperAnswerID = #BIN_PaperAnswerID#,
        ]]>
        <include refid="BINOLCMINC99.updateSql" />
        <![CDATA[
            WHERE
                BIN_VisitTaskID = #BIN_VisitTaskID#
        ]]>
    </update>
    
    <!-- 插入员工入退职信息表  -->
    <insert id="insertEmployeeQuit" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO Basis.BIN_EmployeeQuit(
                BIN_EmployeeID,
                CommencementDate,
        ]]>
        <include refid="BINOLCMINC99.insertKeySql" />
        <![CDATA[
            )
            VALUES
            (
                #employeeID#,
                GETDATE(),
        ]]>
        <include refid="BINOLCMINC99.insertValueSql" />
        <![CDATA[
            )
        ]]>
    </insert>
    
    <!-- 查询新会员的初始积分信息 -->
	<select id="getMemberPoint" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT
				InitialPoint AS initialPoint,
				CONVERT(varchar(30), InitialTime, 121) AS initialTime,
				InitChangablePoint AS initChangablePoint,
				InitTotalChanged AS initTotalChanged,
				TotalPoint AS totalPoint,
				TotalChanged AS totalChanged,
    			ChangablePoint AS changablePoint,
				CurDisablePoint AS curDisablePoint,
				CurDealDate AS curDealDate
			FROM
				Members.BIN_MemberPoint
			WHERE
				BIN_MemberInfoID = #newMemberInfoID#
		]]>	
    </select>
    
    <!-- 更新会员积分信息 -->
    <update id="updateMemberPoint" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Members.BIN_MemberPoint
            SET
            	TotalPoint = #totalPoint#,
            	TotalChanged = #totalChanged#,
            	ChangablePoint = #changablePoint#,
            	CurDisablePoint = #curDisablePoint#,
            	CurDealDate = #curDealDate#,
        ]]>
        	<isNotEmpty property="initialPoint">
        		InitialPoint=ISNULL(InitialPoint,0)+#initialPoint#,
        		InitialTime=#initialTime#,
        	</isNotEmpty>
        	<isNotEmpty property="initChangablePoint">
        		InitChangablePoint=ISNULL(InitChangablePoint,0)+#initChangablePoint#,
        	</isNotEmpty>
        	<isNotEmpty property="initTotalChanged">
        		InitTotalChanged=ISNULL(InitTotalChanged,0)+#initTotalChanged#,
        	</isNotEmpty>
        <include refid="BINOLCMINC99.updateSql" />
        <![CDATA[
            WHERE
                BIN_MemberInfoID = #memberInfoID#
        ]]>
    </update>
    
    <!-- 把新会员积分信息更新成老会员积分信息 -->
    <update id="changeMemberPoint" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Members.BIN_MemberPoint
            SET
            	BIN_MemberInfoID=#memberInfoID#,
        ]]>
        <include refid="BINOLCMINC99.updateSql" />
        <![CDATA[
            WHERE
                BIN_MemberInfoID = #newMemberInfoID#
        ]]>
    </update>
    
    <!-- 查询新会员的扩展信息 -->
	<select id="getMemberExtInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[
			SELECT
				TotalSaleCount AS totalSaleCount,
				LastSaleDate AS lastSaleDate
			FROM
				Members.BIN_MemberExtInfo
			WHERE
				BIN_MemberInfoID = #newMemberInfoID#
		]]>	
    </select>
    
    <!-- 查询销售目标设定表 -->
    <select id="getSaleTarget" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                BIN_SaleTargetID,
                Source,
                CONVERT(VARCHAR(30),TargetSetTime,120) AS TargetSetTime
            FROM
                Monitor.BIN_SaleTarget
            WHERE
                BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
                AND BIN_BrandInfoID = #BIN_BrandInfoID#
                AND Type = #Type#
                AND Parameter = #Parameter#
                AND (TargetType = #TargetType# OR TargetType IS NULL)
                AND TargetDate = #TargetDate#
        ]]> 
    </select>
    
    <!-- 插入销售目标设定表 -->
    <insert id="insertSaleTarget" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO  Monitor.BIN_SaleTarget(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                Type,
                Parameter,
                TargetType,
                TargetDate,
                TargetMoney,
                TargetQuantity,
                SynchroFlag,
                Source,
                TargetSetTime,
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )
            VALUES
            (
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #Type#,
                #Parameter#,
                #TargetType#,
                #TargetDate#,
                #TargetMoney#,
                #TargetQuantity#,
                #SynchroFlag#,
                #Source#,
                #TargetSetTime#,
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </insert>
    
    <!-- 更新销售目标设定表 -->
    <update id="updateSaleTarget" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Monitor.BIN_SaleTarget
            SET
                TargetMoney = #TargetMoney#,
                TargetQuantity = #TargetQuantity#,
                SynchroFlag = #SynchroFlag#,
                Source = #Source#,
                TargetSetTime = #TargetSetTime#,
        ]]>
        <include refid="BINOLCMINC99.updateSql" />
        <![CDATA[
            WHERE
                BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
                AND BIN_BrandInfoID = #BIN_BrandInfoID#
                AND Type = #Type#
                AND Parameter = #Parameter#
                AND (TargetType = #TargetType# OR TargetType IS NULL)
                AND TargetDate = #TargetDate#
        ]]>
    </update>
    
    <!-- 查询会员积分信息是否存在 -->
    <select id="selMemberPointInfo" parameterClass="java.util.HashMap" resultClass ="java.util.HashMap">
    <![CDATA[
        SELECT
            A.BIN_MemberPointID,
            A.LastChangeTime,
            A.ValidFlag
        FROM
            Members.BIN_MemberPoint A
        WHERE
            A.BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
            AND A.BIN_BrandInfoID = #BIN_BrandInfoID#
            AND A.BIN_MemberInfoID = #BIN_MemberInfoID#
    ]]> 
    </select>
    
    <!--插入【会员积分信息表】-->
    <sql id="insertMemberPointSQL">
        <![CDATA[
            INSERT INTO Members.BIN_MemberPoint(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                BIN_MemberInfoID,
        ]]>
        <dynamic>
            <isNotEmpty property="TotalPoint">
                <![CDATA[TotalPoint,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalChanged">
                <![CDATA[TotalChanged,]]>
            </isNotEmpty>
            <isNotEmpty property="ChangablePoint">
                <![CDATA[ChangablePoint,]]>
            </isNotEmpty>
            <isNotEmpty property="FreezePoint">
                <![CDATA[FreezePoint,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalDisablePoint">
                <![CDATA[TotalDisablePoint,]]>
            </isNotEmpty>
            <isNotEmpty property="CurDisablePoint">
                <![CDATA[CurDisablePoint,]]>
            </isNotEmpty>
            <isNotEmpty property="PreCardPoint">
                <![CDATA[PreCardPoint,]]>
            </isNotEmpty>
            <isNotEmpty property="LastChangeTime">
                <![CDATA[LastChangeTime,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialPoint">
                <![CDATA[InitialPoint,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialTime">
                <![CDATA[InitialTime,]]>
            </isNotEmpty>
            <isNotEmpty property="InitChangablePoint">
                <![CDATA[InitChangablePoint,]]>
            </isNotEmpty>
            <isNotEmpty property="InitTotalChanged">
                <![CDATA[InitTotalChanged,]]>
            </isNotEmpty>
            <isNotEmpty property="InitPreCardPoint">
                <![CDATA[InitPreCardPoint,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialLastdate">
                <![CDATA[InitialLastdate,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialID">
                <![CDATA[InitialID,]]>
            </isNotEmpty>
            <isNotEmpty property="PreDisableDate">
                <![CDATA[PreDisableDate,]]>
            </isNotEmpty>
            <isNotEmpty property="CurDealDate">
                <![CDATA[CurDealDate,]]>
            </isNotEmpty>
            <isNotEmpty property="PreDisPointTime">
                <![CDATA[PreDisPointTime,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #BIN_MemberInfoID#,
        ]]>
        <dynamic>
            <isNotEmpty property="TotalPoint">
                <![CDATA[#TotalPoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalChanged">
                <![CDATA[#TotalChanged#,]]>
            </isNotEmpty>
            <isNotEmpty property="ChangablePoint">
                <![CDATA[#ChangablePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="FreezePoint">
                <![CDATA[#FreezePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalDisablePoint">
                <![CDATA[#TotalDisablePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="CurDisablePoint">
                <![CDATA[#CurDisablePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="PreCardPoint">
                <![CDATA[#PreCardPoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="LastChangeTime">
                <![CDATA[#LastChangeTime#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialPoint">
                <![CDATA[#InitialPoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialTime">
                <![CDATA[#InitialTime#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitChangablePoint">
                <![CDATA[#InitChangablePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitTotalChanged">
                <![CDATA[#InitTotalChanged#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitPreCardPoint">
                <![CDATA[#InitPreCardPoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialLastdate">
                <![CDATA[#InitialLastdate#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialID">
                <![CDATA[#InitialID#,]]>
            </isNotEmpty>
            <isNotEmpty property="PreDisableDate">
                <![CDATA[#PreDisableDate#,]]>
            </isNotEmpty>
            <isNotEmpty property="CurDealDate">
                <![CDATA[#CurDealDate#,]]>
            </isNotEmpty>
            <isNotEmpty property="PreDisPointTime">
                <![CDATA[#PreDisPointTime#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </sql>
    <insert id="insertMemberPoint" parameterClass="java.util.HashMap">
        <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_MemberPointID" >
            <include refid="BINBEMQMES03.insertMemberPointSQL" />
            <![CDATA[SELECT SCOPE_IDENTITY() AS value]]>
        </selectKey>
    </insert>
    
    <!-- 更新会员积分表-->
    <update id="updateMemberPointByTimeSequence" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Members.BIN_MemberPoint
            SET
                TotalPoint = #TotalPoint#,
                TotalChanged = #TotalChanged#,
                ChangablePoint = #ChangablePoint#,
                FreezePoint = #FreezePoint#,
        ]]>
        <dynamic>
            <isNotEmpty property="TotalDisablePoint">
                 <![CDATA[TotalDisablePoint = #TotalDisablePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="CurDisablePoint">
                 <![CDATA[CurDisablePoint = #CurDisablePoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="PreCardPoint">
                 <![CDATA[PreCardPoint = #PreCardPoint#,]]>
            </isNotEmpty>
            <isNotEmpty property="LastChangeTime">
                 <![CDATA[LastChangeTime = #LastChangeTime#,]]>
            </isNotEmpty>
            <isNotEmpty property="PreDisableDate">
                 <![CDATA[PreDisableDate = #PreDisableDate#,]]>
            </isNotEmpty>
            <isNotEmpty property="CurDealDate">
                 <![CDATA[CurDealDate = #CurDealDate#,]]>
            </isNotEmpty>
            <isNotEmpty property="PreDisPointTime">
                 <![CDATA[PreDisPointTime = #PreDisPointTime#,]]>
            </isNotEmpty>
        </dynamic>
        <include refid="BINOLCMINC99.updateSql" />
        <![CDATA[
            WHERE
                BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
                AND BIN_BrandInfoID = #BIN_BrandInfoID#
                AND BIN_MemberInfoID = #BIN_MemberInfoID#
                AND (LastChangeTime < #LastChangeTime# OR LastChangeTime IS NULL)
        ]]>
    </update>
    
    <!-- 查询会员积分变化信息是否存在 -->
    <select id="selPointChangeInfo" parameterClass="java.util.HashMap" resultClass ="java.util.HashMap">
    <![CDATA[
        SELECT
            A.BIN_PointChangeID,
            A.ReCalcCount,
            A.ValidFlag
        FROM
            Members.BIN_PointChange A
        WHERE
            A.BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
            AND A.BIN_BrandInfoID = #BIN_BrandInfoID#
            AND A.MemCode = #MemCode#
            AND A.TradeNoIF = #TradeNoIF#
    ]]> 
    </select>
    
    <!--插入【会员积分变化主表】-->
    <sql id="insertPointChangeSQL">
        <![CDATA[
            INSERT INTO Members.BIN_PointChange(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                TradeType,
                BIN_MemberInfoID,
        ]]>
        <dynamic>
            <isNotEmpty property="BIN_OrganizationID">
                <![CDATA[BIN_OrganizationID,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeNoIF">
                <![CDATA[TradeNoIF,]]>
            </isNotEmpty>
            <isNotEmpty property="MemCode">
                <![CDATA[MemCode,]]>
            </isNotEmpty>
            <isNotEmpty property="ChangeDate">
                <![CDATA[ChangeDate,]]>
            </isNotEmpty>
            <isNotEmpty property="Point">
                <![CDATA[Point,]]>
            </isNotEmpty>
            <isNotEmpty property="Amount">
                <![CDATA[Amount,]]>
            </isNotEmpty>
            <isNotEmpty property="Quantity">
                <![CDATA[Quantity,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[BIN_EmployeeID,]]>
            </isNotEmpty>
            <isNotEmpty property="ReCalcCount">
                <![CDATA[ReCalcCount,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialID">
                <![CDATA[InitialID,]]>
            </isNotEmpty>
            <isNotEmpty property="ClearFlag">
                <![CDATA[ClearFlag,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevantUsedNo">
                <![CDATA[RelevantUsedNo,]]>
            </isNotEmpty>
            <isNotEmpty property="DisPointTime">
                <![CDATA[DisPointTime,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #TradeType#,
                #BIN_MemberInfoID#,
        ]]>
        <dynamic>
            <isNotEmpty property="BIN_OrganizationID">
                <![CDATA[#BIN_OrganizationID#,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeNoIF">
                <![CDATA[#TradeNoIF#,]]>
            </isNotEmpty>
            <isNotEmpty property="MemCode">
                <![CDATA[#MemCode#,]]>
            </isNotEmpty>
            <isNotEmpty property="ChangeDate">
                <![CDATA[#ChangeDate#,]]>
            </isNotEmpty>
            <isNotEmpty property="Point">
                <![CDATA[#Point#,]]>
            </isNotEmpty>
            <isNotEmpty property="Amount">
                <![CDATA[#Amount#,]]>
            </isNotEmpty>
            <isNotEmpty property="Quantity">
                <![CDATA[#Quantity#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[#BIN_EmployeeID#,]]>
            </isNotEmpty>
            <isNotEmpty property="ReCalcCount">
                <![CDATA[#ReCalcCount#,]]>
            </isNotEmpty>
            <isNotEmpty property="InitialID">
                <![CDATA[#InitialID#,]]>
            </isNotEmpty>
            <isNotEmpty property="ClearFlag">
                <![CDATA[#ClearFlag#,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevantUsedNo">
                <![CDATA[#RelevantUsedNo#,]]>
            </isNotEmpty>
            <isNotEmpty property="DisPointTime">
                <![CDATA[#DisPointTime#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </sql>
    <insert id="insertPointChange" parameterClass="java.util.HashMap">
        <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_PointChangeID" >
            <include refid="BINBEMQMES03.insertPointChangeSQL" />
            <![CDATA[SELECT SCOPE_IDENTITY() AS value]]>
        </selectKey>
    </insert>
    
    <!--插入【会员积分变化明细表】-->
    <insert id="insertPointChangeDetail" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO Members.BIN_PointChangeDetail(
                BIN_PointChangeID,
        ]]>
        <dynamic>
            <isNotEmpty property="UnitCode">
                <![CDATA[UnitCode,]]>
            </isNotEmpty>
            <isNotEmpty property="BarCode">
                <![CDATA[BarCode,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_PrmPrtVendorID">
                <![CDATA[BIN_PrmPrtVendorID,]]>
            </isNotEmpty>
            <isNotEmpty property="SaleType">
                <![CDATA[SaleType,]]>
            </isNotEmpty>
            <isNotEmpty property="Point">
                <![CDATA[Point,]]>
            </isNotEmpty>
            <isNotEmpty property="ValidMonths">
                <![CDATA[ValidMonths,]]>
            </isNotEmpty>
            <isNotEmpty property="Price">
                <![CDATA[Price,]]>
            </isNotEmpty>
            <isNotEmpty property="Quantity">
                <![CDATA[Quantity,]]>
            </isNotEmpty>
            <isNotEmpty property="PointType">
                <![CDATA[PointType,]]>
            </isNotEmpty>
            <isNotEmpty property="Reason">
                <![CDATA[Reason,]]>
            </isNotEmpty>
            <isNotEmpty property="SubCampaignID">
                <![CDATA[SubCampaignID,]]>
            </isNotEmpty>
            <isNotEmpty property="MainRuleID">
                <![CDATA[MainRuleID,]]>
            </isNotEmpty>
            <isNotEmpty property="CombRuleID">
                <![CDATA[CombRuleID,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevantSRCode">
                <![CDATA[RelevantSRCode,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_PointChangeID#,
        ]]>
        <dynamic>
            <isNotEmpty property="UnitCode">
                <![CDATA[#UnitCode#,]]>
            </isNotEmpty>
            <isNotEmpty property="BarCode">
                <![CDATA[#BarCode#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_PrmPrtVendorID">
                <![CDATA[#BIN_PrmPrtVendorID#,]]>
            </isNotEmpty>
            <isNotEmpty property="SaleType">
                <![CDATA[#SaleType#,]]>
            </isNotEmpty>
            <isNotEmpty property="Point">
                <![CDATA[#Point#,]]>
            </isNotEmpty>
            <isNotEmpty property="ValidMonths">
                <![CDATA[#ValidMonths#,]]>
            </isNotEmpty>
            <isNotEmpty property="Price">
                <![CDATA[#Price#,]]>
            </isNotEmpty>
            <isNotEmpty property="Quantity">
                <![CDATA[#Quantity#,]]>
            </isNotEmpty>
            <isNotEmpty property="PointType">
                <![CDATA[#PointType#,]]>
            </isNotEmpty>
            <isNotEmpty property="Reason">
                <![CDATA[#Reason#,]]>
            </isNotEmpty>
            <isNotEmpty property="SubCampaignID">
                <![CDATA[#SubCampaignID#,]]>
            </isNotEmpty>
            <isNotEmpty property="MainRuleID">
                <![CDATA[#MainRuleID#,]]>
            </isNotEmpty>
            <isNotEmpty property="CombRuleID">
                <![CDATA[#CombRuleID#,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevantSRCode">
                <![CDATA[#RelevantSRCode#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
                )
        ]]>
    </insert>
    
    <!-- 更新会员积分变化主表-->
    <update id="updatePointChange" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Members.BIN_PointChange
            SET
        ]]>
        <dynamic>
            <isNotEmpty property="TradeType">
                 <![CDATA[TradeType = #TradeType#,]]>
            </isNotEmpty>
            <isNotEmpty property="ChangeDate">
                 <![CDATA[ChangeDate = #ChangeDate#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationID">
                 <![CDATA[BIN_OrganizationID = #BIN_OrganizationID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                 <![CDATA[BIN_EmployeeID = #BIN_EmployeeID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Point">
                 <![CDATA[Point = #Point#,]]>
            </isNotEmpty>
            <isNotEmpty property="Amount">
                 <![CDATA[Amount = #Amount#,]]>
            </isNotEmpty>
            <isNotEmpty property="Quantity">
                 <![CDATA[Quantity = #Quantity#,]]>
            </isNotEmpty>
            <isNotEmpty property="ReCalcCount">
                 <![CDATA[ReCalcCount = #ReCalcCount#,]]>
            </isNotEmpty>
        </dynamic>
        <include refid="BINOLCMINC99.updateSql" />
        <![CDATA[
            WHERE
                BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
                AND BIN_BrandInfoID = #BIN_BrandInfoID#
                AND MemCode = #MemCode#
                AND TradeNoIF = #TradeNoIF#
        ]]>
    </update>
    
    <!--删除【会员积分变化明细表】-->
    <delete id="delPointChangeDetail" parameterClass="java.util.HashMap">
        <![CDATA[
            DELETE FROM
                Members.BIN_PointChangeDetail
            WHERE
                BIN_PointChangeID = #BIN_PointChangeID#
        ]]>
    </delete>
    
    <!-- 插入BA考勤信息表 -->
    <insert id="addBAAttendance" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT Monitor.BIN_BAAttendance
            (
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                BIN_EmployeeID,
                BIN_OrganizationID,
                AttendanceDateTime,
                AttendanceType,
        ]]>
        <include refid="BINOLCMINC99.insertKeySql" />
        <![CDATA[
            )
            VALUES
            (
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #BIN_EmployeeID#,
                #BIN_OrganizationID#,
                #AttendanceDateTime#,
                #AttendanceType#,
        ]]>
        <include refid="BINOLCMINC99.insertValueSql" />
        <![CDATA[
            )
        ]]>
    </insert>
    
    <!-- 更新会员激活状态 -->
    <update id="updateMemberActive" parameterClass="java.util.HashMap">
    <![CDATA[
        UPDATE
            Members.BIN_MemberInfo
        SET
            Active = '1',
            ActiveDate = #activeTime#,
            ActiveChannel = #activeChannel#,
    ]]>
    <include refid="BINOLCMINC99.updateSql" />
    <![CDATA[
        WHERE
            BIN_MemberInfoID = #memberInfoID#
    ]]>
    </update>
    
    <!-- 根据手机号查询会员信息数据 -->
    <select id="selMemberInfoByMobilePhone" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        SELECT
            A.BIN_MemberInfoID,
            B.MemCode,
            C.BIN_AddressInfoID,
            D.StandardCity AS MemAddressStandardCity,
            D.StandardProvince AS MemAddressStandardProvince,
            D.ZipCode AS MemAddressZipCode
        FROM
            Members.BIN_MemberInfo A
            LEFT JOIN Members.BIN_MemCardInfo B ON A.BIN_MemberInfoID = B.BIN_MemberInfoID AND B.ValidFlag = '1' and B.CardValidFlag='1'
            LEFT JOIN Members.BIN_MemberAddress C ON A.BIN_MemberInfoID = C.BIN_MemberInfoID AND C.ValidFlag = '1'
            LEFT JOIN Basis.BIN_AddressInfo D ON C.BIN_AddressInfoID = D.BIN_AddressInfoID
        WHERE
            A.BIN_OrganizationInfoID = #BIN_OrganizationInfoID#
            AND  A.BIN_BrandInfoID = #BIN_BrandInfoID#
            AND A.MobilePhone = #MobilePhone#
            AND A.ValidFlag = '1'
    </select>
    
    <!-- 插入短信回复记录表 -->
    <insert id="addMobileMsgReply" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT Communication.BIN_MobileMsgReply
            (
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                BillNo,
                TradeType,
                MessageCodePre,
                MobilePhone,
                MsgContent,
                ReplyTime,
        ]]>
        <isNotEmpty property="EventType">
            <![CDATA[EventType,]]>
        </isNotEmpty>
        <isNotEmpty property="BIN_MemberInfoID">
            <![CDATA[BIN_MemberInfoID,]]>
        </isNotEmpty>
        <isNotEmpty property="BatchID">
            <![CDATA[BatchID,]]>
        </isNotEmpty>
        <isNotEmpty property="Comment">
            <![CDATA[Comment,]]>
        </isNotEmpty>
        <isNotEmpty property="DataSource">
            <![CDATA[DataSource,]]>
        </isNotEmpty>
        <isNotEmpty property="DataValidFlag">
            <![CDATA[DataValidFlag,]]>
        </isNotEmpty>
        <include refid="BINOLCMINC99.insertKeySql" />
        <![CDATA[
            )
            VALUES
            (
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #BillNo#,
                #TradeType#,
                #MessageCodePre#,
                #MobilePhone#,
                #MsgContent#,
                #ReplyTime#,
        ]]>
        <isNotEmpty property="EventType">
            <![CDATA[#EventType#,]]>
        </isNotEmpty>
        <isNotEmpty property="BIN_MemberInfoID">
            <![CDATA[#BIN_MemberInfoID#,]]>
        </isNotEmpty>
        <isNotEmpty property="BatchID">
            <![CDATA[#BatchID#,]]>
        </isNotEmpty>
        <isNotEmpty property="Comment">
            <![CDATA[#Comment#,]]>
        </isNotEmpty>
        <isNotEmpty property="DataSource">
            <![CDATA[#DataSource#,]]>
        </isNotEmpty>
        <isNotEmpty property="DataValidFlag">
            <![CDATA[#DataValidFlag#,]]>
        </isNotEmpty>
        <include refid="BINOLCMINC99.insertValueSql" />
        <![CDATA[
            )
        ]]>
    </insert>
</sqlMap>