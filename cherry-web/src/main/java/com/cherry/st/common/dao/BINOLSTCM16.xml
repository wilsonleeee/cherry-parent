<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BINOLSTCM16"> 
    <!--插入【产品调拨申请单据表】-->
    <sql id="insertProductAllocationSQL">
        <![CDATA[
            INSERT INTO Inventory.BIN_ProductAllocation(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                AllocationrNo,
        ]]>
        <dynamic>
            <isNotEmpty property="AllocationNoIF">
                <![CDATA[AllocationNoIF,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevanceNo">
                <![CDATA[RelevanceNo,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDIn">
                <![CDATA[BIN_OrganizationIDIn,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDOut">
                <![CDATA[BIN_OrganizationIDOut,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[BIN_EmployeeID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDDX">
                <![CDATA[BIN_OrganizationIDDX,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDDX">
                <![CDATA[BIN_EmployeeIDDX,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[BIN_EmployeeIDAudit,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[TotalQuantity,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[TotalAmount,]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[VerifiedFlag,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                <![CDATA[TradeStatus,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogisticInfoID">
                <![CDATA[BIN_LogisticInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[Comments,]]>
            </isNotEmpty>
            <isNotEmpty property="Date">
                <![CDATA[Date,]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[WorkFlowID,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #AllocationrNo#,
        ]]>
        <dynamic>
            <isNotEmpty property="AllocationNoIF">
                <![CDATA[#AllocationNoIF#,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevanceNo">
                <![CDATA[#RelevanceNo#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDIn">
                <![CDATA[#BIN_OrganizationIDIn#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDOut">
                <![CDATA[#BIN_OrganizationIDOut#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[#BIN_EmployeeID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDDX">
                <![CDATA[#BIN_OrganizationIDDX#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDDX">
                <![CDATA[#BIN_EmployeeIDDX#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[#BIN_EmployeeIDAudit#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[#TotalQuantity#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[#TotalAmount#,]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[#VerifiedFlag#,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                <![CDATA[#TradeStatus#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogisticInfoID">
                <![CDATA[#BIN_LogisticInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[#Comments#,]]>
            </isNotEmpty>
            <isNotEmpty property="Date">
                <![CDATA[#Date#,]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[#WorkFlowID#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </sql>
    <insert id="insertProductAllocation" parameterClass="java.util.HashMap">
        <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_ProductAllocationID" >
            <include refid="BINOLSTCM16.insertProductAllocationSQL" />
            <![CDATA[SELECT SCOPE_IDENTITY() AS value]]>
        </selectKey>
    </insert>
    
    <!--插入【产品调拨申请单据明细表】-->
    <insert id="insertProductAllocationDetail" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO Inventory.BIN_ProductAllocationDetail(
                BIN_ProductAllocationID,
                BIN_ProductVendorID,
                DetailNo,
                Quantity,
                BIN_InventoryInfoID,
        ]]>
        <dynamic>
            <isNotEmpty property="Price">
                <![CDATA[Price,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_ProductVendorPackageID">
                <![CDATA[BIN_ProductVendorPackageID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogicInventoryInfoID">
                <![CDATA[BIN_LogicInventoryInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_StorageLocationInfoID">
                <![CDATA[BIN_StorageLocationInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[Comments,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_ProductAllocationID#,
                #BIN_ProductVendorID#,
                #DetailNo#,
                #Quantity#,
                #BIN_InventoryInfoID#,
        ]]>
        <dynamic>
            <isNotEmpty property="Price">
                <![CDATA[#Price#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_ProductVendorPackageID">
                <![CDATA[#BIN_ProductVendorPackageID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogicInventoryInfoID">
                <![CDATA[#BIN_LogicInventoryInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_StorageLocationInfoID">
                <![CDATA[#BIN_StorageLocationInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[#Comments#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
                )
        ]]>
    </insert>

    <!--更新【产品调拨申请单据表】-->
    <update id="updateProductAllocation" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Inventory.BIN_ProductAllocation
            SET
                UpdateTime = GETDATE()
                ,UpdatedBy = #UpdatedBy#
                ,UpdatePGM = #UpdatePGM#
                ,ModifyCount = ModifyCount+1
        ]]>
        <dynamic>
            <isNotEmpty property="ValidFlag">
                <![CDATA[,ValidFlag = #ValidFlag#]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                 <![CDATA[,TradeStatus = #TradeStatus#]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[,WorkFlowID = #WorkFlowID#]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[,VerifiedFlag = #VerifiedFlag#]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[,BIN_EmployeeIDAudit = #BIN_EmployeeIDAudit#]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[,TotalQuantity = #TotalQuantity#]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[,TotalAmount = #TotalAmount#]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[,Comments = #Comments#]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
            WHERE
                BIN_ProductAllocationID = #BIN_ProductAllocationID#
        ]]>
        <isNotEmpty property="OldValidFlag">
              <![CDATA[AND ValidFlag = #OldValidFlag#]]>
        </isNotEmpty>
        <isNotEmpty property="OldUpdateTime">
            <![CDATA[AND UpdateTime = #OldUpdateTime#]]>
        </isNotEmpty>
        <isNotEmpty property="OldModifyCount">
            <![CDATA[AND ModifyCount = #OldModifyCount#]]>
        </isNotEmpty> 
    </update>

    <!--取得产品调拨申请单据表信息-->
    <select id="getProductAllocationMainData" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                A.BIN_OrganizationInfoID
                ,A.BIN_BrandInfoID
                ,A.AllocationrNo
                ,A.AllocationNoIF
                ,A.RelevanceNo
                ,A.BIN_OrganizationIDIn
                ,A.BIN_OrganizationIDOut
                ,A.BIN_EmployeeID
                ,A.BIN_OrganizationIDDX
                ,A.BIN_EmployeeIDDX
                ,A.BIN_EmployeeIDAudit
                ,ISNULL(A.TotalQuantity,0) AS TotalQuantity
                ,ISNULL(A.TotalAmount,0) AS TotalAmount
                ,A.VerifiedFlag
                ,A.TradeStatus
                ,A.BIN_LogisticInfoID
                ,A.VerifiedFlag
                ,A.Comments
                ,A.Date
                ,A.WorkFlowID
                ,A.ValidFlag
                ,CONVERT(VARCHAR(30),A.CreateTime,121) AS CreateTime
                ,CONVERT(VARCHAR(30),A.UpdateTime,121) AS UpdateTime
                ,A.ModifyCount
                ,B.TestType
                ,C.EmployeeCode
                ,B.DepartCode AS DepartCodeIn
                ,E.DepartCode AS DepartCodeOut
        ]]>
        <dynamic>
            <isNotEmpty property="language">
                <isEqual property="language" compareValue="en_US">
                    <![CDATA[
                        ,'('+B.DepartCode+')'+B.NameForeign AS DepartCodeNameIn
                        ,'('+E.DepartCode+')'+E.NameForeign AS DepartCodeNameOut
                        ,C.EmployeeNameForeign AS EmployeeName
                        ,D.EmployeeNameForeign AS EmployeeNameAudit
                    ]]>
                </isEqual>
                <isEqual property="language" compareValue="zh_CN">
                    <![CDATA[
                        ,'('+B.DepartCode+')'+B.DepartName AS DepartCodeNameIn
                        ,'('+E.DepartCode+')'+E.DepartName AS DepartCodeNameOut
                        ,C.EmployeeName
                        ,D.EmployeeName AS EmployeeNameAudit
                    ]]>
                </isEqual>
            </isNotEmpty>
            <isEmpty property="language">
                <![CDATA[
                    ,'('+B.DepartCode+')'+B.DepartName AS DepartCodeNameIn
                    ,'('+E.DepartCode+')'+E.DepartName AS DepartCodeNameOut
                    ,C.EmployeeName
                    ,D.EmployeeName AS EmployeeNameAudit
                ]]>
            </isEmpty>
        </dynamic>
        <![CDATA[
            FROM
                Inventory.BIN_ProductAllocation A
                LEFT JOIN Basis.BIN_Organization B
                ON A.BIN_OrganizationIDIn = B.BIN_OrganizationID
                LEFT JOIN Basis.BIN_Employee C
                ON A.BIN_EmployeeID = C.BIN_EmployeeID
                LEFT JOIN Basis.BIN_Employee D
                ON A.BIN_EmployeeIDAudit = D.BIN_EmployeeID
                LEFT JOIN Basis.BIN_Organization E
                ON A.BIN_OrganizationIDOut = E.BIN_OrganizationID
            WHERE
                A.BIN_ProductAllocationID = #BIN_ProductAllocationID#
        ]]>
    </select>
   
    <!--取得产品调拨申请单据明细表信息-->
    <select id="getProductAllocationDetailData" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                A.BIN_ProductAllocationDetailID
                ,A.BIN_ProductAllocationID
                ,A.BIN_ProductVendorID
                ,A.DetailNo
                ,ISNULL(A.Quantity,0) AS Quantity
                ,ISNULL(A.Price,0) AS Price
                ,A.BIN_ProductVendorPackageID
                ,A.BIN_InventoryInfoID
                ,A.BIN_LogicInventoryInfoID
                ,A.BIN_StorageLocationInfoID
                ,A.Comments
                ,B.BarCode
                ,C.UnitCode
                ,E.LogicInventoryCode
            ]]>
            <dynamic>
                <isNotEmpty property="language">
                    <isEqual property="language" compareValue="en_US">
                        <![CDATA[
                            ,C.NameForeign AS ProductName
                            ,'('+D.DepotCode+')'+D.DepotNameEN AS DepotCodeName
                            ,'('+E.LogicInventoryCode+')'+E.InventoryNameEN AS LogicInventoryCodeName
                        ]]>
                    </isEqual>
                    <isEqual property="language" compareValue="zh_CN">
                        <![CDATA[
                            ,C.NameTotal AS ProductName
                            ,'('+D.DepotCode+')'+D.DepotNameCN AS DepotCodeName
                            ,'('+E.LogicInventoryCode+')'+E.InventoryNameCN AS LogicInventoryCodeName
                        ]]>
                    </isEqual>
                </isNotEmpty>
                <isEmpty property="language">
                    <![CDATA[
                        ,C.NameTotal AS ProductName
                        ,'('+D.DepotCode+')'+D.DepotNameCN AS DepotCodeName
                        ,'('+E.LogicInventoryCode+')'+E.InventoryNameCN AS LogicInventoryCodeName
                    ]]>
                </isEmpty>
            </dynamic>
            <![CDATA[
            FROM
                Inventory.BIN_ProductAllocationDetail A
            LEFT JOIN Basis.BIN_ProductVendor B
            ON A.BIN_ProductVendorID = B.BIN_ProductVendorID
            LEFT JOIN Basis.BIN_Product C
            ON B.BIN_ProductID = C.BIN_ProductID
            LEFT JOIN Basis.BIN_DepotInfo D
            ON A.BIN_InventoryInfoID = D.BIN_DepotInfoID
            LEFT JOIN Basis.BIN_LogicInventory E
            ON A.BIN_LogicInventoryInfoID = E.BIN_LogicInventoryInfoID
            WHERE
                A.BIN_ProductAllocationID = #BIN_ProductAllocationID#
                AND A.ValidFlag = '1'
            ORDER BY UnitCode
        ]]>
    </select>

    <!--插入【产品调出单据表】-->
    <sql id="insertProductAllocationOutSQL">
        <![CDATA[
            INSERT INTO Inventory.BIN_ProductAllocationOut(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                AllocationOutNo,
        ]]>
        <dynamic>
            <isNotEmpty property="AllocationOutNoIF">
                <![CDATA[AllocationOutNoIF,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevanceNo">
                <![CDATA[RelevanceNo,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDIn">
                <![CDATA[BIN_OrganizationIDIn,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDOut">
                <![CDATA[BIN_OrganizationIDOut,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[BIN_EmployeeID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDDX">
                <![CDATA[BIN_OrganizationIDDX,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDDX">
                <![CDATA[BIN_EmployeeIDDX,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[BIN_EmployeeIDAudit,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[TotalQuantity,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[TotalAmount,]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[VerifiedFlag,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                <![CDATA[TradeStatus,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogisticInfoID">
                <![CDATA[BIN_LogisticInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[Comments,]]>
            </isNotEmpty>
            <isNotEmpty property="Date">
                <![CDATA[Date,]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[WorkFlowID,]]>
            </isNotEmpty>
            <!-- 暂时先将此字段在初次写入置为1（MQ上来的数据也是直接置为1，此处与其保持一致） -->
            <![CDATA[SynchFlag,]]>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #AllocationOutNo#,
        ]]>
        <dynamic>
            <isNotEmpty property="AllocationOutNoIF">
                <![CDATA[#AllocationOutNoIF#,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevanceNo">
                <![CDATA[#RelevanceNo#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDIn">
                <![CDATA[#BIN_OrganizationIDIn#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDOut">
                <![CDATA[#BIN_OrganizationIDOut#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[#BIN_EmployeeID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDDX">
                <![CDATA[#BIN_OrganizationIDDX#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDDX">
                <![CDATA[#BIN_EmployeeIDDX#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[#BIN_EmployeeIDAudit#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[#TotalQuantity#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[#TotalAmount#,]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[#VerifiedFlag#,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                <![CDATA[#TradeStatus#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogisticInfoID">
                <![CDATA[#BIN_LogisticInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[#Comments#,]]>
            </isNotEmpty>
            <isNotEmpty property="Date">
                <![CDATA[#Date#,]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[#WorkFlowID#,]]>
            </isNotEmpty>
            <![CDATA['1',]]>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </sql>
    <insert id="insertProductAllocationOut" parameterClass="java.util.HashMap">
        <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_ProductAllocationOutID" >
            <include refid="BINOLSTCM16.insertProductAllocationOutSQL" />
            <![CDATA[SELECT SCOPE_IDENTITY() AS value]]>
        </selectKey>
    </insert>
    
    <!--插入【产品调出单据明细表】-->
    <insert id="insertProductAllocationOutDetail" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO Inventory.BIN_ProductAllocationOutDetail(
                BIN_ProductAllocationOutID,
                BIN_ProductVendorID,
                DetailNo,
                Quantity,
                BIN_InventoryInfoID,
        ]]>
        <dynamic>
            <isNotEmpty property="Price">
                <![CDATA[Price,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_ProductVendorPackageID">
                <![CDATA[BIN_ProductVendorPackageID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogicInventoryInfoID">
                <![CDATA[BIN_LogicInventoryInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_StorageLocationInfoID">
                <![CDATA[BIN_StorageLocationInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[Comments,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_ProductAllocationOutID#,
                #BIN_ProductVendorID#,
                #DetailNo#,
                #Quantity#,
                #BIN_InventoryInfoID#,
        ]]>
        <dynamic>
            <isNotEmpty property="Price">
                <![CDATA[#Price#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_ProductVendorPackageID">
                <![CDATA[#BIN_ProductVendorPackageID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogicInventoryInfoID">
                <![CDATA[#BIN_LogicInventoryInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_StorageLocationInfoID">
                <![CDATA[#BIN_StorageLocationInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[#Comments#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
                )
        ]]>
    </insert>

    <!--更新【产品调出单据表】-->
    <update id="updateProductAllocationOut" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE
                Inventory.BIN_ProductAllocationOut
            SET
                UpdateTime = GETDATE()
                ,UpdatedBy = #UpdatedBy#
                ,UpdatePGM = #UpdatePGM#
                ,ModifyCount = ModifyCount+1
        ]]>
        <dynamic>
            <isNotEmpty property="TradeStatus">
                 <![CDATA[,TradeStatus = #TradeStatus#]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                 <![CDATA[,VerifiedFlag = #VerifiedFlag#]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                 <![CDATA[,TotalQuantity = #TotalQuantity#]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                 <![CDATA[,TotalAmount = #TotalAmount#]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
            WHERE
                BIN_ProductAllocationOutID = #BIN_ProductAllocationOutID#
        ]]>
        <isNotEmpty property="OldValidFlag">
              <![CDATA[AND ValidFlag = #OldValidFlag#]]>
        </isNotEmpty>
        <isNotEmpty property="OldUpdateTime">
            <![CDATA[AND UpdateTime = #OldUpdateTime#]]>
        </isNotEmpty>
        <isNotEmpty property="OldModifyCount">
            <![CDATA[AND ModifyCount = #OldModifyCount#]]>
        </isNotEmpty> 
    </update>

    <!--取得产品调出单据表信息-->
    <select id="getProductAllocationOutMainData" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                A.BIN_OrganizationInfoID
                ,A.BIN_BrandInfoID
                ,A.AllocationOutNo
                ,A.AllocationOutNoIF
                ,A.RelevanceNo
                ,A.BIN_OrganizationIDIn
                ,A.BIN_OrganizationIDOut
                ,A.BIN_EmployeeID
                ,A.BIN_OrganizationIDDX
                ,A.BIN_EmployeeIDDX
                ,A.BIN_EmployeeIDAudit
                ,ISNULL(A.TotalQuantity,0) AS TotalQuantity
                ,ISNULL(A.TotalAmount,0) AS TotalAmount
                ,A.VerifiedFlag
                ,A.TradeStatus
                ,A.BIN_LogisticInfoID
                ,A.VerifiedFlag
                ,A.Comments
                ,A.Date
                ,A.WorkFlowID
                ,A.ValidFlag
                ,CONVERT(VARCHAR(30),A.CreateTime,121) AS CreateTime
                ,CONVERT(VARCHAR(30),A.UpdateTime,121) AS UpdateTime
                ,A.ModifyCount
                ,B.TestType
                ,C.EmployeeCode
        ]]>
        <dynamic>
            <isNotEmpty property="language">
                <isEqual property="language" compareValue="en_US">
                    <![CDATA[
                        ,'('+B.DepartCode+')'+B.NameForeign AS DepartCodeNameIn
                        ,'('+E.DepartCode+')'+E.NameForeign AS DepartCodeNameOut
                        ,C.EmployeeNameForeign AS EmployeeName
                        ,D.EmployeeNameForeign AS EmployeeNameAudit
                    ]]>
                </isEqual>
                <isEqual property="language" compareValue="zh_CN">
                    <![CDATA[
                        ,'('+B.DepartCode+')'+B.DepartName AS DepartCodeNameIn
                        ,'('+E.DepartCode+')'+E.DepartName AS DepartCodeNameOut
                        ,C.EmployeeName
                        ,D.EmployeeName AS EmployeeNameAudit
                    ]]>
                </isEqual>
            </isNotEmpty>
            <isEmpty property="language">
                <![CDATA[
                    ,'('+B.DepartCode+')'+B.DepartName AS DepartCodeNameIn
                    ,'('+E.DepartCode+')'+E.DepartName AS DepartCodeNameOut
                    ,C.EmployeeName
                    ,D.EmployeeName AS EmployeeNameAudit
                ]]>
            </isEmpty>
        </dynamic>
        <![CDATA[
            FROM
                Inventory.BIN_ProductAllocationOut A
                LEFT JOIN Basis.BIN_Organization B
                ON A.BIN_OrganizationIDIn = B.BIN_OrganizationID
                LEFT JOIN Basis.BIN_Employee C
                ON A.BIN_EmployeeID = C.BIN_EmployeeID
                LEFT JOIN Basis.BIN_Employee D
                ON A.BIN_EmployeeIDAudit = D.BIN_EmployeeID
                LEFT JOIN Basis.BIN_Organization E
                ON A.BIN_OrganizationIDOut = E.BIN_OrganizationID
            WHERE
                A.BIN_ProductAllocationOutID = #BIN_ProductAllocationOutID#
        ]]>
    </select>
   
    <!--取得产品调拨申请单据明细表信息-->
    <select id="getProductAllocationOutDetailData" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                 cast(A.TotalCostPrice	 as decimal(16,2) ) AS  TotalCostPrice
			    ,cast(   A.TotalCostPrice / cast (A.Quantity as decimal(16,2)) as decimal(16,2)) AS AvgCostPrice														
                ,A.BIN_ProductAllocationOutDetailID
                ,A.BIN_ProductAllocationOutID
                ,A.BIN_ProductVendorID
                ,A.DetailNo
                ,ISNULL(A.Quantity,0) AS Quantity
                ,ISNULL(A.Price,0) AS Price
                ,A.BIN_ProductVendorPackageID
                ,A.BIN_InventoryInfoID
                ,A.BIN_LogicInventoryInfoID
                ,A.BIN_StorageLocationInfoID
                ,A.Comments
                ,B.BarCode
                ,C.UnitCode
                ,E.LogicInventoryCode
            ]]>
            <dynamic>
                <isNotEmpty property="language">
                    <isEqual property="language" compareValue="en_US">
                        <![CDATA[
                            ,C.NameForeign AS ProductName
                            ,'('+D.DepotCode+')'+D.DepotNameEN AS DepotCodeName
                            ,'('+E.LogicInventoryCode+')'+E.InventoryNameEN AS LogicInventoryCodeName
                        ]]>
                    </isEqual>
                    <isEqual property="language" compareValue="zh_CN">
                        <![CDATA[
                            ,C.NameTotal AS ProductName
                            ,'('+D.DepotCode+')'+D.DepotNameCN AS DepotCodeName
                            ,'('+E.LogicInventoryCode+')'+E.InventoryNameCN AS LogicInventoryCodeName
                        ]]>
                    </isEqual>
                </isNotEmpty>
                <isEmpty property="language">
                    <![CDATA[
                        ,C.NameTotal AS ProductName
                        ,'('+D.DepotCode+')'+D.DepotNameCN AS DepotCodeName
                        ,'('+E.LogicInventoryCode+')'+E.InventoryNameCN AS LogicInventoryCodeName
                    ]]>
                </isEmpty>
            </dynamic>
            <![CDATA[
            FROM
                Inventory.BIN_ProductAllocationOutDetail A
            LEFT JOIN Basis.BIN_ProductVendor B
            ON A.BIN_ProductVendorID = B.BIN_ProductVendorID
            LEFT JOIN Basis.BIN_Product C
            ON B.BIN_ProductID = C.BIN_ProductID
            LEFT JOIN Basis.BIN_DepotInfo D
            ON A.BIN_InventoryInfoID = D.BIN_DepotInfoID
            LEFT JOIN Basis.BIN_LogicInventory E
            ON A.BIN_LogicInventoryInfoID = E.BIN_LogicInventoryInfoID
            WHERE
                A.BIN_ProductAllocationOutID = #BIN_ProductAllocationOutID#
                AND A.ValidFlag = '1'
            ORDER BY UnitCode
        ]]>
    </select>
    
    
    
    
    
    
    
    
    
    
    
    
    
    <!--插入【产品调入单据表】-->
    <sql id="insertProductAllocationInSQL">
        <![CDATA[
            INSERT INTO Inventory.BIN_ProductAllocationIn(
                BIN_OrganizationInfoID,
                BIN_BrandInfoID,
                AllocationInNo,
        ]]>
        <dynamic>
            <isNotEmpty property="AllocationInNoIF">
                <![CDATA[AllocationInNoIF,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevanceNo">
                <![CDATA[RelevanceNo,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDIn">
                <![CDATA[BIN_OrganizationIDIn,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDOut">
                <![CDATA[BIN_OrganizationIDOut,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[BIN_EmployeeID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDDX">
                <![CDATA[BIN_OrganizationIDDX,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDDX">
                <![CDATA[BIN_EmployeeIDDX,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[BIN_EmployeeIDAudit,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[TotalQuantity,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[TotalAmount,]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[VerifiedFlag,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                <![CDATA[TradeStatus,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogisticInfoID">
                <![CDATA[BIN_LogisticInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[Comments,]]>
            </isNotEmpty>
            <isNotEmpty property="Date">
                <![CDATA[Date,]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[WorkFlowID,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_OrganizationInfoID#,
                #BIN_BrandInfoID#,
                #AllocationInNo#,
        ]]>
        <dynamic>
            <isNotEmpty property="AllocationInNoIF">
                <![CDATA[#AllocationInNoIF#,]]>
            </isNotEmpty>
            <isNotEmpty property="RelevanceNo">
                <![CDATA[#RelevanceNo#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDIn">
                <![CDATA[#BIN_OrganizationIDIn#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDOut">
                <![CDATA[#BIN_OrganizationIDOut#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeID">
                <![CDATA[#BIN_EmployeeID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_OrganizationIDDX">
                <![CDATA[#BIN_OrganizationIDDX#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDDX">
                <![CDATA[#BIN_EmployeeIDDX#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_EmployeeIDAudit">
                <![CDATA[#BIN_EmployeeIDAudit#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalQuantity">
                <![CDATA[#TotalQuantity#,]]>
            </isNotEmpty>
            <isNotEmpty property="TotalAmount">
                <![CDATA[#TotalAmount#,]]>
            </isNotEmpty>
            <isNotEmpty property="VerifiedFlag">
                <![CDATA[#VerifiedFlag#,]]>
            </isNotEmpty>
            <isNotEmpty property="TradeStatus">
                <![CDATA[#TradeStatus#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogisticInfoID">
                <![CDATA[#BIN_LogisticInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[#Comments#,]]>
            </isNotEmpty>
            <isNotEmpty property="Date">
                <![CDATA[#Date#,]]>
            </isNotEmpty>
            <isNotEmpty property="WorkFlowID">
                <![CDATA[#WorkFlowID#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
            )
        ]]>
    </sql>
    <insert id="insertProductAllocationIn" parameterClass="java.util.HashMap">
        <selectKey resultClass="java.lang.Integer" type="post" keyProperty="BIN_ProductAllocationInID" >
            <include refid="BINOLSTCM16.insertProductAllocationInSQL" />
            <![CDATA[SELECT SCOPE_IDENTITY() AS value]]>
        </selectKey>
    </insert>
    
    <!--插入【产品调入单据明细表】-->
    <insert id="insertProductAllocationInDetail" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO Inventory.BIN_ProductAllocationInDetail(
                BIN_ProductAllocationInID,
                BIN_ProductVendorID,
                DetailNo,
                Quantity,
                BIN_InventoryInfoID,
        ]]>
        <dynamic>
            <isNotEmpty property="Price">
                <![CDATA[Price,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_ProductVendorPackageID">
                <![CDATA[BIN_ProductVendorPackageID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogicInventoryInfoID">
                <![CDATA[BIN_LogicInventoryInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_StorageLocationInfoID">
                <![CDATA[BIN_StorageLocationInfoID,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[Comments,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                ValidFlag,
                CreateTime,
                CreatedBy,
                CreatePGM,
                UpdateTime,
                UpdatedBy,
                UpdatePGM,
                ModifyCount
            )VALUES(
                #BIN_ProductAllocationInID#,
                #BIN_ProductVendorID#,
                #DetailNo#,
                #Quantity#,
                #BIN_InventoryInfoID#,
        ]]>
        <dynamic>
            <isNotEmpty property="Price">
                <![CDATA[#Price#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_ProductVendorPackageID">
                <![CDATA[#BIN_ProductVendorPackageID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_LogicInventoryInfoID">
                <![CDATA[#BIN_LogicInventoryInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="BIN_StorageLocationInfoID">
                <![CDATA[#BIN_StorageLocationInfoID#,]]>
            </isNotEmpty>
            <isNotEmpty property="Comments">
                <![CDATA[#Comments#,]]>
            </isNotEmpty>
        </dynamic>
        <![CDATA[
                '1',
                GETDATE(),
                #CreatedBy#,
                #CreatePGM#,
                GETDATE(),
                #UpdatedBy#,
                #UpdatePGM#,
                '0'
                )
        ]]>
    </insert>

    <!--取得产品调入单据表信息-->
    <select id="getProductAllocationInMainData" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                A.BIN_OrganizationInfoID
                ,A.BIN_BrandInfoID
                ,A.AllocationInNo
                ,A.AllocationInNoIF
                ,A.RelevanceNo
                ,A.BIN_OrganizationIDIn
                ,A.BIN_OrganizationIDOut
                ,A.BIN_EmployeeID
                ,A.BIN_OrganizationIDDX
                ,A.BIN_EmployeeIDDX
                ,A.BIN_EmployeeIDAudit
                ,ISNULL(A.TotalQuantity,0) AS TotalQuantity
                ,ISNULL(A.TotalAmount,0) AS TotalAmount
                ,A.VerifiedFlag
                ,A.TradeStatus
                ,A.BIN_LogisticInfoID
                ,A.VerifiedFlag
                ,A.Comments
                ,A.Date
                ,A.WorkFlowID
                ,A.ValidFlag
                ,CONVERT(VARCHAR(30),A.CreateTime,121) AS CreateTime
                ,CONVERT(VARCHAR(30),A.UpdateTime,121) AS UpdateTime
                ,A.ModifyCount
                ,B.TestType
                ,C.EmployeeCode
        ]]>
        <dynamic>
            <isNotEmpty property="language">
                <isEqual property="language" compareValue="en_US">
                    <![CDATA[
                        ,'('+B.DepartCode+')'+B.NameForeign AS DepartCodeNameIn
                        ,'('+E.DepartCode+')'+E.NameForeign AS DepartCodeNameOut
                        ,C.EmployeeNameForeign AS EmployeeName
                        ,D.EmployeeNameForeign AS EmployeeNameAudit
                    ]]>
                </isEqual>
                <isEqual property="language" compareValue="zh_CN">
                    <![CDATA[
                        ,'('+B.DepartCode+')'+B.DepartName AS DepartCodeNameIn
                        ,'('+E.DepartCode+')'+E.DepartName AS DepartCodeNameOut
                        ,C.EmployeeName
                        ,D.EmployeeName AS EmployeeNameAudit
                    ]]>
                </isEqual>
            </isNotEmpty>
            <isEmpty property="language">
                <![CDATA[
                    ,'('+B.DepartCode+')'+B.DepartName AS DepartCodeNameIn
                    ,'('+E.DepartCode+')'+E.DepartName AS DepartCodeNameOut
                    ,C.EmployeeName
                    ,D.EmployeeName AS EmployeeNameAudit
                ]]>
            </isEmpty>
        </dynamic>
        <![CDATA[
            FROM
                Inventory.BIN_ProductAllocationIn A
                LEFT JOIN Basis.BIN_Organization B
                ON A.BIN_OrganizationIDIn = B.BIN_OrganizationID
                LEFT JOIN Basis.BIN_Employee C
                ON A.BIN_EmployeeID = C.BIN_EmployeeID
                LEFT JOIN Basis.BIN_Employee D
                ON A.BIN_EmployeeIDAudit = D.BIN_EmployeeID
                LEFT JOIN Basis.BIN_Organization E
                ON A.BIN_OrganizationIDOut = E.BIN_OrganizationID
            WHERE
                A.BIN_ProductAllocationInID = #BIN_ProductAllocationInID#
        ]]>
    </select>
   
    <!--取得产品调入单据明细表信息-->
    <select id="getProductAllocationInDetailData" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
        <![CDATA[
            SELECT
                 cast(A.TotalCostPrice	 as decimal(16,2) ) AS  TotalCostPrice
			    ,cast(   A.TotalCostPrice / cast (A.Quantity as decimal(16,2)) as decimal(16,2)) AS AvgCostPrice														
                ,A.BIN_ProductAllocationInDetailID
                ,A.BIN_ProductAllocationInID
                ,A.BIN_ProductVendorID
                ,A.DetailNo
                ,ISNULL(A.Quantity,0) AS Quantity
                ,ISNULL(A.Price,0) AS Price
                ,A.BIN_ProductVendorPackageID
                ,A.BIN_InventoryInfoID
                ,A.BIN_LogicInventoryInfoID
                ,A.BIN_StorageLocationInfoID
                ,A.Comments
                ,B.BarCode
                ,C.UnitCode
                ,E.LogicInventoryCode
            ]]>
            <dynamic>
                <isNotEmpty property="language">
                    <isEqual property="language" compareValue="en_US">
                        <![CDATA[
                            ,C.NameForeign AS ProductName
                            ,'('+D.DepotCode+')'+D.DepotNameEN AS DepotCodeName
                            ,'('+E.LogicInventoryCode+')'+E.InventoryNameEN AS LogicInventoryCodeName
                        ]]>
                    </isEqual>
                    <isEqual property="language" compareValue="zh_CN">
                        <![CDATA[
                            ,C.NameTotal AS ProductName
                            ,'('+D.DepotCode+')'+D.DepotNameCN AS DepotCodeName
                            ,'('+E.LogicInventoryCode+')'+E.InventoryNameCN AS LogicInventoryCodeName
                        ]]>
                    </isEqual>
                </isNotEmpty>
                <isEmpty property="language">
                    <![CDATA[
                        ,C.NameTotal AS ProductName
                        ,'('+D.DepotCode+')'+D.DepotNameCN AS DepotCodeName
                        ,'('+E.LogicInventoryCode+')'+E.InventoryNameCN AS LogicInventoryCodeName
                    ]]>
                </isEmpty>
            </dynamic>
            <![CDATA[
            FROM
                Inventory.BIN_ProductAllocationInDetail A
            LEFT JOIN Basis.BIN_ProductVendor B
            ON A.BIN_ProductVendorID = B.BIN_ProductVendorID
            LEFT JOIN Basis.BIN_Product C
            ON B.BIN_ProductID = C.BIN_ProductID
            LEFT JOIN Basis.BIN_DepotInfo D
            ON A.BIN_InventoryInfoID = D.BIN_DepotInfoID
            LEFT JOIN Basis.BIN_LogicInventory E
            ON A.BIN_LogicInventoryInfoID = E.BIN_LogicInventoryInfoID
            WHERE
                A.BIN_ProductAllocationInID = #BIN_ProductAllocationInID#
                AND A.ValidFlag = '1'
            ORDER BY UnitCode
        ]]>
    </select>
    
    <!-- 判断调出单号存在 -->
    <select id="selProductAllocationOut" parameterClass="java.util.HashMap" resultClass ="java.util.HashMap">
        <![CDATA[
        SELECT  
            A.BIN_ProductAllocationOutID,
            A.RelevanceNo,
            A.WorkFlowID,
            A.BIN_EmployeeID,
            A.BIN_EmployeeIDAudit
        FROM  
            Inventory.BIN_ProductAllocationOut A
        WHERE 
            A.AllocationOutNoIF = #billNo#
            AND A.ValidFlag = '1'
        ]]>
    </select>
</sqlMap>